import 'dart:convert';

import 'package:shared_preferences/shared_preferences.dart';
import 'package:your_finance_flutter/core/models/asset_item.dart';
import 'package:your_finance_flutter/core/models/transaction.dart';
import 'package:your_finance_flutter/core/services/data_migration_service.dart';

/// æ•°æ®è¿ç§»æµ‹è¯•è„šæœ¬
/// ç”¨äºæµ‹è¯•æ•°æ®è¿ç§»åŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œ
void main() async {
  print('ğŸ§ª å¼€å§‹æ•°æ®è¿ç§»æµ‹è¯•...');

  // åˆå§‹åŒ–SharedPreferences
  final prefs = await SharedPreferences.getInstance();

  // æ¸…ç†æ—§æ•°æ®
  await prefs.clear();
  print('ğŸ—‘ï¸ å·²æ¸…ç†æ—§æ•°æ®');

  // åˆ›å»ºæ¨¡æ‹Ÿçš„æ—§æ ¼å¼æ•°æ®
  await _createMockOldData(prefs);

  // æµ‹è¯•æ•°æ®è¿ç§»
  await _testMigration(prefs);

  // éªŒè¯è¿ç§»ç»“æœ
  await _verifyMigrationResults(prefs);

  print('âœ… æ•°æ®è¿ç§»æµ‹è¯•å®Œæˆ');
}

/// åˆ›å»ºæ¨¡æ‹Ÿçš„æ—§æ ¼å¼æ•°æ®
Future<void> _createMockOldData(SharedPreferences prefs) async {
  print('ğŸ“ åˆ›å»ºæ¨¡æ‹Ÿæ—§æ ¼å¼æ•°æ®...');

  // èµ„äº§æ•°æ®ï¼šä½¿ç”¨æ—§çš„fixedAssetsåˆ†ç±»
  final oldAssets = [
    {
      'id': 'asset_1',
      'name': 'æµ‹è¯•æˆ¿äº§',
      'amount': 1000000.0,
      'category': 'fixedAssets', // æ—§æ ¼å¼
      'subCategory': 'æˆ¿äº§(è‡ªä½)',
      'creationDate': DateTime.now().toIso8601String(),
      'updateDate': DateTime.now().toIso8601String(),
      'purchaseDate':
          DateTime.now().subtract(const Duration(days: 365)).toIso8601String(),
      'depreciationMethod': 'straightLine',
      'depreciationRate': 0.02,
      'currentValue': 980000.0,
      'isIdle': false,
      'idleValue': null,
      'notes': 'æµ‹è¯•æˆ¿äº§',
    },
    {
      'id': 'asset_2',
      'name': 'æµ‹è¯•ç°é‡‘',
      'amount': 50000.0,
      'category': 'liquidAssets', // è¿™ä¸ªæ˜¯æ­£ç¡®çš„
      'subCategory': 'é“¶è¡Œæ´»æœŸ',
      'creationDate': DateTime.now().toIso8601String(),
      'updateDate': DateTime.now().toIso8601String(),
      'purchaseDate': null,
      'depreciationMethod': 'none',
      'depreciationRate': null,
      'currentValue': null,
      'isIdle': false,
      'idleValue': null,
      'notes': 'æµ‹è¯•ç°é‡‘',
    },
  ];

  // äº¤æ˜“æ•°æ®ï¼šä½¿ç”¨æ—§çš„TransactionType
  final oldTransactions = [
    {
      'id': 'transaction_1',
      'description': 'å·¥èµ„æ”¶å…¥',
      'amount': 10000.0,
      'type': 'income', // æ—§æ ¼å¼
      'category': 'salary',
      'subCategory': null,
      'fromAccountId': null,
      'toAccountId': 'account_1',
      'envelopeBudgetId': null,
      'date': DateTime.now().toIso8601String(),
      'notes': null,
      'tags': <String>[],
      'status': 'confirmed',
      'isRecurring': false,
      'recurringRule': null,
      'parentTransactionId': null,
      'creationDate': DateTime.now().toIso8601String(),
      'updateDate': DateTime.now().toIso8601String(),
      'imagePath': null,
      'isAutoGenerated': false,
    },
    {
      'id': 'transaction_2',
      'description': 'è´­ç‰©æ”¯å‡º',
      'amount': 500.0,
      'type': 'expense', // æ—§æ ¼å¼
      'category': 'shopping',
      'subCategory': null,
      'fromAccountId': 'account_1',
      'toAccountId': null,
      'envelopeBudgetId': null,
      'date': DateTime.now().toIso8601String(),
      'notes': null,
      'tags': <String>[],
      'status': 'confirmed',
      'isRecurring': false,
      'recurringRule': null,
      'parentTransactionId': null,
      'creationDate': DateTime.now().toIso8601String(),
      'updateDate': DateTime.now().toIso8601String(),
      'imagePath': null,
      'isAutoGenerated': false,
    },
  ];

  // ä¿å­˜åˆ°SharedPreferences
  await prefs.setString('assets_data', jsonEncode(oldAssets));
  await prefs.setString('transactions_data', jsonEncode(oldTransactions));

  print('âœ… æ¨¡æ‹Ÿæ—§æ•°æ®åˆ›å»ºå®Œæˆ');
}

/// æµ‹è¯•æ•°æ®è¿ç§»
Future<void> _testMigration(SharedPreferences prefs) async {
  print('ğŸ”„ å¼€å§‹æµ‹è¯•æ•°æ®è¿ç§»...');

  final migrationService = await DataMigrationService.getInstance();

  // æ‰§è¡Œè¿ç§»
  await migrationService.checkAndMigrateData();

  print('âœ… æ•°æ®è¿ç§»æµ‹è¯•æ‰§è¡Œå®Œæˆ');
}

/// éªŒè¯è¿ç§»ç»“æœ
Future<void> _verifyMigrationResults(SharedPreferences prefs) async {
  print('ğŸ” éªŒè¯è¿ç§»ç»“æœ...');

  // éªŒè¯èµ„äº§æ•°æ®è¿ç§»
  final assetsJson = prefs.getString('assets_data');
  if (assetsJson != null) {
    final assets = jsonDecode(assetsJson) as List<dynamic>;

    for (final assetJson in assets) {
      final asset = AssetItem.fromJson(assetJson as Map<String, dynamic>);

      print('ğŸ“Š èµ„äº§: ${asset.name}');
      print('   åŸå§‹åˆ†ç±»: ${assetJson['category']}');
      print('   è¿ç§»ååˆ†ç±»: ${asset.category.name}');

      // éªŒè¯åˆ†ç±»æ˜¯å¦æ­£ç¡®è¿ç§»
      if (asset.name == 'æµ‹è¯•æˆ¿äº§') {
        assert(asset.category.name == 'realEstate', 'æˆ¿äº§åˆ†ç±»è¿ç§»å¤±è´¥');
        print('   âœ… æˆ¿äº§åˆ†ç±»è¿ç§»æˆåŠŸ');
      } else if (asset.name == 'æµ‹è¯•ç°é‡‘') {
        assert(asset.category.name == 'liquidAssets', 'ç°é‡‘åˆ†ç±»åº”è¯¥ä¿æŒä¸å˜');
        print('   âœ… ç°é‡‘åˆ†ç±»ä¿æŒæ­£ç¡®');
      }
    }
  }

  // éªŒè¯äº¤æ˜“æ•°æ®è¿ç§»
  final transactionsJson = prefs.getString('transactions_data');
  if (transactionsJson != null) {
    final transactions = jsonDecode(transactionsJson) as List<dynamic>;

    for (final transactionJson in transactions) {
      final transaction =
          Transaction.fromJson(transactionJson as Map<String, dynamic>);

      print('ğŸ’¸ äº¤æ˜“: ${transaction.description}');
      print('   åŸå§‹ç±»å‹: ${transactionJson['type']}');
      print('   è¿ç§»åæµå‘: ${transaction.flow?.name ?? 'æœªè®¾ç½®'}');

      // éªŒè¯æµå‘æ˜¯å¦æ­£ç¡®æ¨æ–­
      if (transaction.description == 'å·¥èµ„æ”¶å…¥') {
        assert(
          transaction.flow == TransactionFlow.externalToWallet,
          'æ”¶å…¥æµå‘æ¨æ–­å¤±è´¥',
        );
        print('   âœ… æ”¶å…¥æµå‘æ¨æ–­æˆåŠŸ');
      } else if (transaction.description == 'è´­ç‰©æ”¯å‡º') {
        assert(
          transaction.flow == TransactionFlow.walletToExternal,
          'æ”¯å‡ºæµå‘æ¨æ–­å¤±è´¥',
        );
        print('   âœ… æ”¯å‡ºæµå‘æ¨æ–­æˆåŠŸ');
      }
    }
  }

  // éªŒè¯è¿ç§»ç‰ˆæœ¬
  final version = prefs.getInt('data_migration_version');
  print('ğŸ“‹ å½“å‰æ•°æ®ç‰ˆæœ¬: $version');
  assert(version == 2, 'ç‰ˆæœ¬å·æœªæ­£ç¡®æ›´æ–°');

  print('âœ… è¿ç§»ç»“æœéªŒè¯å®Œæˆï¼Œæ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼');
}
