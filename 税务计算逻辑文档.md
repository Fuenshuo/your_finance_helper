# 家庭资产记账应用 - 税务计算逻辑详解

## 概述

本文档详细说明了家庭资产记账应用中个人所得税的计算逻辑，包括工资薪金、奖金、专项附加扣除等各项的计算规则和实现方式。

## 核心计算服务

### 1. PersonalIncomeTaxService - 个人所得税计算服务

#### 税率阶梯表 (2021年起最新税率)

```dart
static const List<TaxBracket> _taxBrackets = [
  TaxBracket(threshold: 0, rate: 0.03, deduction: 0),          // 不超过36,000元
  TaxBracket(threshold: 36000, rate: 0.10, deduction: 2520),   // 超过36,000元至144,000元的部分
  TaxBracket(threshold: 144000, rate: 0.20, deduction: 16920), // 超过144,000元至300,000元的部分
  TaxBracket(threshold: 300000, rate: 0.25, deduction: 31920), // 超过300,000元至420,000元的部分
  TaxBracket(threshold: 420000, rate: 0.30, deduction: 52920), // 超过420,000元至660,000元的部分
  TaxBracket(threshold: 660000, rate: 0.35, deduction: 85920), // 超过660,000元至960,000元的部分
  TaxBracket(threshold: 960000, rate: 0.45, deduction: 181920), // 超过960,000元的部分
];
```

#### 修正后的精确计算公式（根据用户验证）

**个人所得税 = 工资税**

**工资税 = 当月应纳税所得额 × 税率 - 速算扣除数**

**当月应纳税所得额 = 当月收入合计（去除年终奖） - 当月五险一金扣除 - 当月起征点（5000） - 当月专项附加扣除 - 当月其他免税收入**

#### 税率和速算扣除数表

| 应税收入合计 | 税率 | 速算扣除数 |
|-------------|------|-----------|
| 不超过36,000元 | 3% | 0.00 |
| 超过36,000元至144,000元的部分 | 10% | 2,520.00 |
| 超过144,000元至300,000元的部分 | 20% | 16,920.00 |
| 超过300,000元至420,000元的部分 | 25% | 31,920.00 |
| 超过420,000元至660,000元的部分 | 30% | 52,920.00 |
| 超过660,000元至960,000元的部分 | 35% | 85,920.00 |
| 超过960,000元的部分 | 45% | 181,920.00 |

#### 往月预扣工资税计算
往月预扣工资税需要从一月开始逐月累积计算，每个月的预扣税额都基于当时的全年预测重新计算。

#### 月度预扣预缴计算

**标准模式**（从年初开始计算）：
1. 计算当月应纳税所得额
2. 计算全年累计应纳税所得额（当月 × 累计月数）
3. 计算全年应纳税额
4. 计算当月预扣税额 = 全年应纳税额 - 已预扣税款

**年中模式**（年中开始使用）：
1. 基于实际累计收入数据计算
2. 考虑剩余月份的收入预测
3. 采用更精确的预扣预缴算法

### 2. SalaryCalculationService - 薪资计算服务

#### 收入构成计算

**月收入** = 基本工资 + 住房补贴 + 餐补 + 交通补贴 + 其他补贴 + 绩效奖金

**年收入** = 月收入 × 12 + 年度奖金 + 一次性奖金

#### 专项附加扣除计算

**子女教育**：每月1,000元/子女
**赡养老人**：每月2,000元/人
**继续教育**：
- 学历继续教育：每月400元
- 职业资格继续教育：每月300元
**住房贷款利息**：每月1,000元
**住房租金**：
- 一线城市：每月1,500元
- 二线城市：每月1,100元
- 三线城市：每月800元
**婴幼儿照护**：每月1,000元/子女
**个人养老金**：每月不超过1,000元（年度不超过12,000元）

### 3. 奖金税收计算逻辑

#### 奖金类型分类

1. **年终奖**：单独计税，奖金÷12后适用月度税率，再×12
2. **季度奖金**：跟随工资收入计税
3. **十三薪**：跟随工资收入计税
4. **其他奖金**：跟随工资收入计税

#### 年终奖计税公式

```dart
// 年终奖按月均分计算税率
final monthlyEquivalent = yearEndBonus / 12;
final monthlyTax = calculateMonthlyTax(monthlyEquivalent, 0, 0, 0);
final annualTax = monthlyTax * 12;
```

## 计算流程详解

### 1. 工资薪金所得税计算流程（修正后算法）

#### 步骤1：计算当月应纳税所得额
```dart
// 当月收入合计（去除年终奖）
monthlyIncome = basicSalary + housingAllowance + mealAllowance + transportationAllowance + otherAllowance + performanceBonus

// 当月五险一金扣除
monthlyDeductions = socialInsurance + housingFund + otherDeductions

// 当月专项附加扣除
monthlySpecialDeduction = calculateDetailedDeductions(...)

// 当月其他免税收入
monthlyTaxFreeIncome = 0 // 通常为0

// 当月起征点
monthlyThreshold = 5000.0

// 当月应纳税所得额 = 当月收入合计 - 当月五险一金 - 当月起征点 - 当月专项附加扣除 - 当月其他免税收入
monthlyTaxableIncome = monthlyIncome - monthlyDeductions - monthlyThreshold - monthlySpecialDeduction - monthlyTaxFreeIncome
```

#### 步骤2：确定适用税率和速算扣除数
```dart
// 直接使用当月应纳税所得额确定税率阶梯
for (var i = taxBrackets.length - 1; i >= 0; i--) {
  if (monthlyTaxableIncome > taxBrackets[i].threshold) {
    applicableBracket = taxBrackets[i];
    break;
  }
}
```

#### 步骤3：计算当月预扣税额
```dart
// 当月预扣税额 = 当月应纳税所得额 × 税率 - 速算扣除数
monthlyTax = monthlyTaxableIncome * applicableBracket.rate - applicableBracket.deduction
```

### 2. 年终奖所得税计算流程

#### 步骤1：月均分计算
```dart
// 年终奖月均额
monthlyBonus = yearEndBonus / 12;
```

#### 步骤2：适用月度税率
```dart
// 找到适用的税率阶梯
for (var i = taxBrackets.length - 1; i >= 0; i--) {
  if (monthlyBonus > taxBrackets[i].threshold) {
    applicableBracket = taxBrackets[i];
    break;
  }
}

// 计算月税额
monthlyTax = (monthlyBonus - applicableBracket.threshold) * applicableBracket.rate + applicableBracket.deduction;
```

#### 步骤3：年度税额计算
```dart
// 年终奖年度税额
annualBonusTax = monthlyTax * 12;
```

### 3. 专项附加扣除详细计算

#### 子女教育扣除
```dart
childrenDeduction = childrenCount * 1000; // 每月1000元/子女
```

#### 赡养老人扣除
```dart
elderlyDeduction = elderlyCount * 2000; // 每月2000元/人
```

#### 继续教育扣除
```dart
if (continuingEducation) {
  if (educationType == 'degree') {
    educationDeduction = 400; // 学历继续教育
  } else {
    educationDeduction = 300; // 职业资格继续教育
  }
}
```

#### 住房贷款利息扣除
```dart
if (housingLoanInterest) {
  loanInterestDeduction = 1000; // 每月1000元
}
```

#### 住房租金扣除
```dart
if (rentalHousing) {
  switch (cityLevel) {
    case 'first': rentalDeduction = 1500; break;  // 一线城市
    case 'second': rentalDeduction = 1100; break; // 二线城市
    case 'third': rentalDeduction = 800; break;   // 三线城市
  }
}
```

#### 婴幼儿照护扣除
```dart
infantDeduction = infantCount * 1000; // 每月1000元/子女
```

#### 个人养老金扣除
```dart
if (personalPension) {
  // 每月不超过1000元，年度不超过12000元
  pensionDeduction = (pensionContribution / 12).clamp(0.0, 1000.0);
}
```

## 计算示例

### 示例1：月薪15,000元，标准扣除（精确算法）

#### 基本数据
- 月薪：15,000元（去除年终奖）
- 五险一金：3,000元
- 专项附加扣除：5,000元
- 其他免税收入：0元
- 当前月：第6月

#### 计算过程
1. **本年应税收入合计**：
   - 本年收入合计 = 15,000 × 12 = 180,000元
   - 本年起征点合计 = 5,000 × 12 = 60,000元
   - 累计扣除合计 = (3,000 + 5,000 + 0) × 12 = 96,000元
   - 应税收入合计 = 180,000 - 60,000 - 96,000 = 24,000元

2. **适用税率阶梯**：24,000元处于第2阶梯（超过36,000元至144,000元的部分）
   - 税率：10%，速算扣除数：2,520.00元

3. **全年应纳税额**：
   - 全年应纳税额 = (24,000 - 36,000) × 10% + 2,520 = 0 × 10% + 2,520 = 2,520元
   - 注意：由于应税收入24,000元小于起征点36,000元，全年应纳税额为0

4. **往月预扣工资税**：由于全年应纳税额为0，往月预扣税也为0

5. **第6月预扣税额**：2,520 - 0 = 2,520元（实际为0，因为全年税额为0）

#### 说明
这个例子显示了精确算法的特点：即使月收入较高，但由于专项附加扣除较大，可能导致全年应纳税所得额低于起征点，从而无需缴税。

### 示例2：年终奖50,000元

#### 计算过程
1. **月均分**：50,000 ÷ 12 ≈ 4,167元
2. **适用税率阶梯**：4,167元处于第2阶梯（3,000-12,000元）
3. **月税额**：(4,167 - 3,000) × 10% + 252 = 1,167 × 0.1 + 252 = 116.7 + 252 = 368.7元
4. **年终奖税额**：368.7 × 12 ≈ 4,424元
5. **税后年终奖**：50,000 - 4,424 = 45,576元

## 最终实现验证

### ✅ 已实现的精确算法

基于用户提供的精确公式，现已完全实现：

#### 核心计算公式
**个人所得税 = 工资税**

**工资税 = 本年应税收入合计 × 税率（工资）年度 - 速算扣除数（工资）年度 - 往月预扣工资税**

**本年应税收入合计 = 本年收入合计（去除年终奖） - 本年起征点合计（5000×月数） - 累计扣除合计（(社保+公积金+附加扣除+免税收入+其他扣除)×月数）**

#### 实际运行结果验证（基于用户提供的真实案例）

运行用户提供的1月数据：

```
输入数据：
- 本年收入合计：¥79,170
- 五险一金扣除：¥7,250.65
- 起征点：¥5,000
- 专项附加扣除：¥1,800

应纳税所得额计算：
¥79,170 - ¥7,250.65 - ¥5,000 - ¥1,800 = ¥65,119.35

税率阶梯确定：
- 应纳税所得额：¥65,119.35
- 适用阶梯：超过36,000元至144,000元的部分
- 税率：10%
- 速算扣除数：¥2,520

税额计算：
¥65,119.35 × 0.10 - ¥2,520 = ¥3,991.94

结果验证：
- 计算结果：¥3,991.94
- 实际结果：¥3,991.94
- 验证状态：✅ 完全一致！
```

#### 计算逻辑验证

1. **当月应税所得额计算正确**：直接用当月数据计算，无需累积全年
2. **税率阶梯确定正确**：65,119.35元落在10%税率阶梯
3. **税额计算精确**：65119.35 × 0.1 - 2520 = 3991.94
4. **与实际结果完全匹配**：验证了算法的正确性

### 🎯 修正后的算法特点

1. **简化计算逻辑**：直接用当月数据计算当月税额，无需复杂的全年预测
2. **精确起征点处理**：每月固定5,000元起征点
3. **当月扣除项直接计算**：社保、公积金、专项附加扣除等当月扣除
4. **税率直接应用**：基于当月应纳税所得额直接确定适用税率

### 📋 关键实现方法

- `calculateMonthlyTax()` - 修正后的月度预扣预缴计算
- 直接计算当月应纳税所得额并应用税率
- 无需累积全年预测和往月税款计算

## 相关文件

- `lib/services/personal_income_tax_service.dart` - 个税计算核心服务
- `lib/services/salary_calculation_service.dart` - 薪资和扣除计算服务
- `lib/models/bonus_item.dart` - 奖金项目数据模型
- `lib/screens/salary_income_setup_screen.dart` - 工资设置界面

## 验证建议

建议通过以下方式验证税务计算的准确性：

1. **单元测试**：为每个计算方法编写完整的单元测试
2. **边界测试**：测试各税率阶梯的边界值
3. **实际案例**：使用真实的工资单进行验证
4. **政策对照**：与最新税务政策进行对比验证

## 最新更新（2025年）

### 完整的税务计算系统

基于用户提供的实际数据，已实现完整的个人所得税计算系统，包括工资薪金和年终奖：

#### 核心算法
1. **工资薪金税**：年度累积预扣法
2. **年终奖税**：专用税率阶梯法

#### 新增方法
```dart
/// 计算当月工资预扣税（年度累积法）
/// 公式：当月预扣税 = 本年应税收入合计 × 税率 - 速算扣除数 - 往月预扣税合计
static double calculateMonthlyWithholdingTax(double annualTaxableIncome, double previousMonthsTax)

/// 计算年终奖税额（专用税率阶梯）
/// 计税方法：年度奖金计税额 ÷ 12，对应税率阶梯获取税率和速算扣除数
/// 公式：年度奖金税 = 年度奖金计税额 × 税率 - 速算扣除数
static double calculateYearEndBonusTax(double yearEndBonus)
```

#### 年终奖专用税率阶梯
```
应税收入合计     税率    速算扣除数
不超过3,000元    3%     0.00
超过3,000-12,000 10%    210.00
超过12,000-25,000 20%   1,410.00
超过25,000-35,000 25%   2,660.00
超过35,000-55,000 30%   4,410.00
超过55,000-80,000 35%   7,160.00
超过80,000       45%    15,160.00
```

#### 2月验证结果
```
输入数据：
- 本年收入合计：¥109,915.26
- 五险一金扣除：¥7,250.65 × 2 = ¥14,501.30
- 起征点：¥5,000 × 2 = ¥10,000
- 专项附加扣除：¥1,800 × 2 = ¥3,600
- 往月预扣税合计：¥3,991.94

计算过程：
本年应税收入合计 = ¥109,915.26 - ¥14,501.30 - ¥10,000 - ¥3,600 = ¥81,813.96
年度税额 = ¥81,813.96 × 0.10 - ¥2,520 = ¥5,661.40
当月预扣税 = ¥5,661.40 - ¥3,991.94 = ¥1,669.46

验证结果：
- 计算结果：¥1,669.46
- 实际结果：¥1,669.46
- 验证状态：✅ 完全一致！
```

#### 3月验证结果
```
输入数据：
- 本年收入合计：¥141,019.07（1月79,170 + 2月30,745.26 + 3月31,103.81）
- 五险一金扣除：¥7,250.65 × 3 = ¥21,751.95
- 起征点：¥5,000 × 3 = ¥15,000
- 专项附加扣除：¥1,800 × 3 = ¥5,400
- 往月预扣税合计：¥5,661.40（1月3,991.94 + 2月1,669.46）

计算过程：
本年应税收入合计 = ¥141,019.07 - ¥21,751.95 - ¥15,000 - ¥5,400 = ¥98,867.12
年度税额 = ¥98,867.12 × 0.10 - ¥2,520 = ¥7,366.71
当月预扣税 = ¥7,366.71 - ¥5,661.40 = ¥1,705.31

验证结果：
- 计算结果：¥1,705.31
- 实际结果：¥1,705.31
- 验证状态：✅ 完全一致！
```

#### 4月验证结果（部分）
```
输入数据：
- 本年收入合计：¥197,113.17（去除年终奖）
- 五险一金扣除：¥7,250.65 × 4 = ¥29,002.60
- 起征点：¥5,000 × 4 = ¥20,000
- 专项附加扣除：¥1,800 × 4 = ¥7,200
- 往月预扣税合计：¥7,366.71

工资税计算过程：
本年应税收入合计 = ¥197,113.17 - ¥29,002.60 - ¥20,000 - ¥7,200 = ¥140,910.57
年度工资税额 = ¥140,910.57 × 0.10 - ¥2,520 = ¥11,571.06
当月工资预扣税 = ¥11,571.06 - ¥7,366.71 = ¥4,204.35

验证结果：
- 工资税计算结果：¥4,204.35
- 工资税实际结果：¥4,204.35
- 验证状态：✅ 完全一致！

年终奖税计算：
- 年终奖金额：¥190,000
- 月均额：¥190,000 ÷ 12 = ¥15,833.33
- 适用税率阶梯：超过12,000元至25,000元的部分，税率20%，速算扣除数1,410
- 计算结果：¥190,000 × 0.2 - ¥1,410 = ¥36,590
- 实际结果：¥36,590
- 状态：✅ 完全一致！
```

#### 完整验证结果

##### 工资薪金税验证
| 月份 | 计算结果 | 实际结果 | 状态 |
|------|----------|----------|------|
| 1月  | ¥3,991.94 | ¥3,991.94 | ✅ |
| 2月  | ¥1,669.46 | ¥1,669.46 | ✅ |
| 3月  | ¥1,705.31 | ¥1,705.31 | ✅ |
| 4月  | ¥4,204.35 | ¥4,204.35 | ✅ |

##### 年终奖税验证
- 年终奖金额：¥190,000
- 月均额：¥15,833.33
- 适用阶梯：超过12,000-25,000元，税率20%，速算扣除数1,410
- 计算结果：¥36,590
- 实际结果：¥36,590
- 验证状态：✅ 完全一致！

#### 使用说明
1. **工资税计算**：`calculateMonthlyWithholdingTax(annualTaxableIncome, previousMonthsTax)`
2. **年终奖税计算**：`calculateYearEndBonusTax(yearEndBonus)`
3. **本年应税收入合计**：年收入合计 - 五险一金×月数 - 起征点×月数 - 专项附加扣除×月数

---

*本文档基于2021年最新个人所得税政策编写，实际使用时请以最新政策为准。*
