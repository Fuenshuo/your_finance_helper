import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import 'package:your_finance_flutter/core/models/bonus_item.dart';
import 'package:your_finance_flutter/core/models/budget.dart';
import 'package:your_finance_flutter/core/providers/budget_provider.dart';
import 'package:your_finance_flutter/core/services/salary_calculation_service.dart';
import 'package:your_finance_flutter/core/theme/app_theme.dart';
import 'package:your_finance_flutter/core/widgets/amount_input_field.dart';
import 'package:your_finance_flutter/core/widgets/app_animations.dart';
import 'package:your_finance_flutter/core/widgets/app_card.dart';
import 'package:your_finance_flutter/features/family_info/widgets/bonus_management_widget.dart';
import 'package:your_finance_flutter/features/family_info/widgets/monthly_allowance_adjustment_widget.dart';
import 'package:your_finance_flutter/features/family_info/widgets/salary_basic_info_widget.dart';
import 'package:your_finance_flutter/features/family_info/widgets/salary_history_widget.dart';
import 'package:your_finance_flutter/features/family_info/widgets/tax_deductions_widget.dart';
import 'package:your_finance_flutter/screens/tax_calculation_mode_selection_screen.dart';

class SalaryIncomeSetupScreen extends StatefulWidget {
  const SalaryIncomeSetupScreen({
    super.key,
    this.salaryIncomeToEdit,
  });
  final SalaryIncome? salaryIncomeToEdit;

  @override
  State<SalaryIncomeSetupScreen> createState() =>
      _SalaryIncomeSetupScreenState();
}

// ËÆæÁΩÆÊ≠•È™§Êûö‰∏æ
enum SetupStep {
  basicInfo,     // Âü∫Á°Ä‰ø°ÊÅØ
  bonusSetup,    // Â•ñÈáëËÆæÁΩÆ
  allowanceAdjustment, // Ê¥•Ë¥¥Ë∞ÉÊï¥
  preview        // È¢ÑËßà
}

class _SalaryIncomeSetupScreenState extends State<SalaryIncomeSetupScreen> {
  final _formKey = GlobalKey<FormState>();

  // Basic controllers
  final _nameController = TextEditingController();
  final _basicSalaryController = TextEditingController();

  // Allowance controllers
  final _housingAllowanceController = TextEditingController();
  final _mealAllowanceController = TextEditingController();
  final _transportationAllowanceController = TextEditingController();
  final _otherAllowanceController = TextEditingController();

  // Deduction controllers
  final _socialInsuranceController = TextEditingController();
  final _housingFundController = TextEditingController();
  final _otherDeductionsController = TextEditingController();
  final _specialDeductionController = TextEditingController();
  final _otherTaxFreeIncomeController = TextEditingController();
  final _otherTaxDeductionsController = TextEditingController(); // ÂÖ∂‰ªñÁ®éÊî∂Êâ£Èô§

  // State variables
  SetupStep _currentStep = SetupStep.basicInfo; // ÂΩìÂâçÊ≠•È™§

  int _salaryDay = 10;
  bool _isMidYearMode = false;
  bool _useAutoCalculation = false;
  bool _isLoading = false;
  double _specialDeductionMonthly = 0;
  double _cumulativeIncome = 0;
  double _cumulativeTax = 0;
  int _completedMonths = 0; // Ê∑ªÂä†Áº∫Â§±ÁöÑÂèòÈáè

  // Controllers for cumulative data input
  final _cumulativeIncomeController = TextEditingController();
  final _cumulativeTaxController = TextEditingController();

  // Salary history
  final Map<DateTime, double> _salaryHistory = {};

  // Bonuses
  final List<BonusItem> _bonuses = [];

  // Monthly allowances
  final Map<int, AllowanceRecord> _monthlyAllowances = {};

  @override
  void initState() {
    super.initState();
    print('üìù SalaryIncomeSetupScreen initState called');
    
    if (widget.salaryIncomeToEdit != null) {
      print('üìù Initializing with existing salary income: ${widget.salaryIncomeToEdit!.name}');
      print('üìù Initial bonuses count: ${widget.salaryIncomeToEdit!.bonuses.length}');
      for (var i = 0; i < widget.salaryIncomeToEdit!.bonuses.length; i++) {
        final bonus = widget.salaryIncomeToEdit!.bonuses[i];
        print('  Bonus $i: ${bonus.name}, type: ${bonus.type}, amount: ${bonus.amount}');
      }
      
      final salaryIncome = widget.salaryIncomeToEdit!;
      
      _nameController.text = salaryIncome.name;
      _basicSalaryController.text = salaryIncome.basicSalary.toString();
      _housingAllowanceController.text = salaryIncome.housingAllowance.toString();
      _mealAllowanceController.text = salaryIncome.mealAllowance.toString();
      _transportationAllowanceController.text = salaryIncome.transportationAllowance.toString();
      _otherAllowanceController.text = salaryIncome.otherAllowance.toString();
      _socialInsuranceController.text = salaryIncome.socialInsurance.toString();
      _housingFundController.text = salaryIncome.housingFund.toString();
      _otherDeductionsController.text = salaryIncome.otherDeductions.toString();
      _specialDeductionController.text = salaryIncome.specialDeductionMonthly.toString();
      _otherTaxDeductionsController.text = salaryIncome.otherTaxDeductions.toString(); // ÂÖ∂‰ªñÁ®éÊî∂Êâ£Èô§
      _salaryDay = salaryIncome.salaryDay;
      
      if (salaryIncome.salaryHistory != null) {
        _salaryHistory.addAll(salaryIncome.salaryHistory!);
      }
      
      _bonuses.addAll(salaryIncome.bonuses);
      
      // ÂàùÂßãÂåñÊúàÂ∫¶Ê¥•Ë¥¥ËÆ∞ÂΩï
      if (salaryIncome.monthlyAllowances != null) {
        _monthlyAllowances.addAll(salaryIncome.monthlyAllowances!);
      }
    }
  }

  @override
  void dispose() {
    print('üìù SalaryIncomeSetupScreen dispose called with bonuses: $_bonuses');
    _disposeControllers();
    super.dispose();
  }

  void _disposeControllers() {
    _nameController.dispose();
    _basicSalaryController.dispose();
    _housingAllowanceController.dispose();
    _mealAllowanceController.dispose();
    _transportationAllowanceController.dispose();
    _otherAllowanceController.dispose();
    _socialInsuranceController.dispose();
    _housingFundController.dispose();
    _otherDeductionsController.dispose();
    _specialDeductionController.dispose();
    _otherTaxFreeIncomeController.dispose();
    _otherTaxDeductionsController.dispose(); // ÂÖ∂‰ªñÁ®éÊî∂Êâ£Èô§
    _cumulativeIncomeController.dispose();
    _cumulativeTaxController.dispose();
  }

  Future<void> _updateCumulativeIncome() async {
    final result = await SalaryCalculationService.calculateAutoCumulative(
      completedMonths: _completedMonths,
      salaryHistory: _salaryHistory,
      basicSalary: double.tryParse(_basicSalaryController.text) ?? 0,
      housingAllowance: double.tryParse(_housingAllowanceController.text) ?? 0,
      mealAllowance: double.tryParse(_mealAllowanceController.text) ?? 0,
      transportationAllowance:
          double.tryParse(_transportationAllowanceController.text) ?? 0,
      otherAllowance: double.tryParse(_otherAllowanceController.text) ?? 0,
      performanceBonus: 0,
      socialInsurance: double.tryParse(_socialInsuranceController.text) ?? 0,
      housingFund: double.tryParse(_housingFundController.text) ?? 0,
      specialDeductionMonthly: _specialDeductionMonthly,
      otherTaxFreeIncome:
          double.tryParse(_otherTaxFreeIncomeController.text) ?? 0,
      otherTaxFreeMonthly:
          double.tryParse(_otherTaxFreeIncomeController.text) ?? 0,
      bonuses: _bonuses,
    );

    setState(() {
      _cumulativeIncome = result.totalIncome;
      _cumulativeTax = result.totalTax;
    });
  }

  void _onSpecialDeductionChanged(double value) {
    if (value != _specialDeductionMonthly) {
      setState(() {
        _specialDeductionMonthly = value.clamp(0, 5000);
      });
    }
  }

  Future<void> _saveIncome() async {
    print('üìù Saving income with bonuses: $_bonuses');
    if (!_formKey.currentState!.validate()) {
      print('‚ùå Form validation failed');
      return;
    }

    setState(() {
      _isLoading = true;
    });

    try {
      final budgetProvider =
          Provider.of<BudgetProvider>(context, listen: false);

      if (widget.salaryIncomeToEdit != null) {
        print('üìù Updating existing salary income');
        print('üìù Original salary income ID: ${widget.salaryIncomeToEdit!.id}');
        // ÁºñËæëÊ®°ÂºèÔºöÊõ¥Êñ∞Áé∞ÊúâÂ∑•ËµÑÊî∂ÂÖ•
        final updatedIncome = widget.salaryIncomeToEdit!.copyWith(
          name: _nameController.text.trim(),
          basicSalary: double.parse(_basicSalaryController.text),
          salaryDay: _salaryDay,
          housingAllowance:
              double.tryParse(_housingAllowanceController.text) ?? 0,
          mealAllowance: double.tryParse(_mealAllowanceController.text) ?? 0,
          transportationAllowance:
              double.tryParse(_transportationAllowanceController.text) ?? 0,
          otherAllowance: double.tryParse(_otherAllowanceController.text) ?? 0,
          monthlyAllowances: _monthlyAllowances.isNotEmpty
              ? _monthlyAllowances
              : null, // ÊúàÂ∫¶Ê¥•Ë¥¥ËÆ∞ÂΩï
          socialInsurance: double.tryParse(_socialInsuranceController.text) ?? 0,
          housingFund: double.tryParse(_housingFundController.text) ?? 0,
          otherDeductions: double.tryParse(_otherDeductionsController.text) ?? 0,
          specialDeductionMonthly: _specialDeductionMonthly,
          otherTaxDeductions:
              double.tryParse(_otherTaxDeductionsController.text) ?? 0, // ÂÖ∂‰ªñÁ®éÊî∂Êâ£Èô§
          salaryHistory:
              _salaryHistory.isNotEmpty ? _salaryHistory : null, // Â∑•ËµÑÂéÜÂè≤
          bonuses: _bonuses,
          updateDate: DateTime.now(),
        );
        await budgetProvider.updateSalaryIncome(updatedIncome);
        print('‚úÖ Salary income updated successfully');
      } else {
        print('üìù Creating new salary income');
        // ÂàõÂª∫Ê®°ÂºèÔºöÂàõÂª∫Êñ∞Â∑•ËµÑÊî∂ÂÖ•
        await budgetProvider.createSalaryIncome(
          name: _nameController.text.trim(),
          basicSalary: double.parse(_basicSalaryController.text),
          salaryDay: _salaryDay,
          housingAllowance:
              double.tryParse(_housingAllowanceController.text) ?? 0,
          mealAllowance: double.tryParse(_mealAllowanceController.text) ?? 0,
          transportationAllowance:
              double.tryParse(_transportationAllowanceController.text) ?? 0,
          otherAllowance: double.tryParse(_otherAllowanceController.text) ?? 0,
          monthlyAllowances: _monthlyAllowances.isNotEmpty
              ? _monthlyAllowances
              : null, // ÊúàÂ∫¶Ê¥•Ë¥¥ËÆ∞ÂΩï
          socialInsurance:
              double.tryParse(_socialInsuranceController.text) ?? 0,
          housingFund: double.tryParse(_housingFundController.text) ?? 0,
          otherDeductions:
              double.tryParse(_otherDeductionsController.text) ?? 0,
          specialDeductionMonthly: _specialDeductionMonthly,
          otherTaxDeductions:
              double.tryParse(_otherTaxDeductionsController.text) ?? 0, // ÂÖ∂‰ªñÁ®éÊî∂Êâ£Èô§
          salaryHistory:
              _salaryHistory.isNotEmpty ? _salaryHistory : null, // Â∑•ËµÑÂéÜÂè≤
          bonuses: _bonuses,
        );
        print('‚úÖ New salary income created successfully');
      }

      if (mounted) {
        setState(() {
          _isLoading = false;
        });
        // ËøîÂõû‰∏ä‰∏ÄÈ°µ
        Navigator.of(context).pop();
      }
    } catch (e) {
      print('‚ùå Error saving salary income: $e');
      if (mounted) {
        setState(() {
          _isLoading = false;
        });
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(content: Text('‰øùÂ≠òÂ§±Ë¥•ÔºåËØ∑ÈáçËØï')),
        );
      }
    }
  }

  void _navigateToTaxCalculationMode() {
    print('üìù Navigating to tax calculation mode with bonuses: $_bonuses');
    Navigator.of(context).push(
      AppAnimations.createRoute(
        TaxCalculationModeSelectionScreen(
          salaryIncome: SalaryIncome(
            id: widget.salaryIncomeToEdit?.id ?? '',
            name: _nameController.text.trim(),
            basicSalary: double.tryParse(_basicSalaryController.text) ?? 0,
            salaryDay: _salaryDay,
            housingAllowance:
                double.tryParse(_housingAllowanceController.text) ?? 0,
            mealAllowance: double.tryParse(_mealAllowanceController.text) ?? 0,
            transportationAllowance:
                double.tryParse(_transportationAllowanceController.text) ?? 0,
            otherAllowance:
                double.tryParse(_otherAllowanceController.text) ?? 0,
            socialInsurance:
                double.tryParse(_socialInsuranceController.text) ?? 0,
            housingFund: double.tryParse(_housingFundController.text) ?? 0,
            otherDeductions:
                double.tryParse(_otherDeductionsController.text) ?? 0,
            specialDeductionMonthly: _specialDeductionMonthly,
            salaryHistory: _salaryHistory,
            bonuses: _bonuses,
            creationDate:
                widget.salaryIncomeToEdit?.creationDate ?? DateTime.now(),
            updateDate: DateTime.now(),
          ),
        ),
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: context.primaryBackground,
      appBar: AppBar(
        title: const Text('ËÆæÁΩÆÂ∑•ËµÑÊî∂ÂÖ•'),
        backgroundColor: Colors.white,
        elevation: 0,
        actions: [
          TextButton(
            onPressed: () {
              print('üìù Save button pressed in app bar');
              _saveIncome();
            },
            child: _isLoading
                ? const SizedBox(
                    width: 20,
                    height: 20,
                    child: CircularProgressIndicator(strokeWidth: 2),
                  )
                : const Text('‰øùÂ≠ò'),
          ),
        ],
      ),
      body: GestureDetector(
        onTap: () {
          FocusScope.of(context).unfocus();
        },
        child: Column(
          children: [
            // Ê≠•È™§ÊåáÁ§∫Âô®
            Container(
              padding: EdgeInsets.symmetric(
                horizontal: context.responsiveSpacing24,
                vertical: context.responsiveSpacing16,
              ),
              color: Colors.white,
              child: Row(
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  _buildStepIndicator('Â°´ÂÜôÊî∂ÂÖ•', _currentStep.index >= 0),
                  _buildStepConnector(),
                  _buildStepIndicator('Â•ñÈáëËÆæÁΩÆ', _currentStep.index >= 1),
                  _buildStepConnector(),
                  _buildStepIndicator('Ê¥•Ë¥¥Ë∞ÉÊï¥', _currentStep.index >= 2),
                  _buildStepConnector(),
                  _buildStepIndicator('Êü•ÁúãÁªìÊûú', _currentStep.index >= 3),
                ],
              ),
            ),
            
            // ÂÜÖÂÆπÂå∫Âüü
            Expanded(
              child: SingleChildScrollView(
                padding: EdgeInsets.all(context.spacing16),
                child: Form(
                  key: _formKey,
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      // Ê†πÊçÆÂΩìÂâçÊ≠•È™§ÊòæÁ§∫‰∏çÂêåÂÜÖÂÆπ
                      if (_currentStep == SetupStep.basicInfo) ...[
                        // Basic Information Section
                        SalaryBasicInfoWidget(
                          nameController: _nameController,
                          basicSalaryController: _basicSalaryController,
                          salaryDay: _salaryDay,
                          isMidYearMode: _isMidYearMode,
                          useAutoCalculation: _useAutoCalculation,
                          onSalaryDayChanged: (value) =>
                              setState(() => _salaryDay = value),
                          onMidYearModeChanged: (value) =>
                              setState(() => _isMidYearMode = value),
                          onAutoCalculationChanged: (value) {
                            setState(() => _useAutoCalculation = value);
                            if (value) {
                              _updateCumulativeIncome();
                            }
                          },
                        ),

                        SizedBox(height: context.spacing16),

                        // Mid-year mode cumulative data input
                        if (_isMidYearMode) ...[
                          AppAnimations.animatedListItem(
                            index: 1,
                            child: AppCard(
                              child: Padding(
                                padding: EdgeInsets.all(context.spacing16),
                                child: Column(
                                  crossAxisAlignment: CrossAxisAlignment.start,
                                  children: [
                                    Text(
                                      'Á¥ØËÆ°Êï∞ÊçÆÔºà‰ªäÂπ¥Â∑≤Êî∂Â∑•ËµÑÊÉÖÂÜµÔºâ',
                                      style: Theme.of(context)
                                          .textTheme
                                          .titleLarge
                                          ?.copyWith(
                                            fontWeight: FontWeight.bold,
                                          ),
                                    ),
                                    SizedBox(height: context.spacing16),

                                    // Â∑≤ÂÆåÊàêÊúà‰ªΩÊï∞
                                    Text(
                                      'Â∑≤Êî∂Â∑•ËµÑÊúà‰ªΩÊï∞',
                                      style: Theme.of(context)
                                          .textTheme
                                          .bodyLarge
                                          ?.copyWith(
                                            fontWeight: FontWeight.w500,
                                          ),
                                    ),
                                    SizedBox(height: context.spacing8),
                                    Row(
                                      children: [
                                        const Icon(
                                          Icons.calendar_month,
                                          color: Colors.orange,
                                        ),
                                        SizedBox(width: context.spacing8),
                                        Text(
                                          '$_completedMonths / 12 ‰∏™Êúà',
                                          style: Theme.of(context)
                                              .textTheme
                                              .bodyMedium,
                                        ),
                                        SizedBox(width: context.spacing8),
                                        Expanded(
                                          child: Slider(
                                            value: _completedMonths.toDouble(),
                                            min: 0,
                                            max: 12,
                                            divisions: 12,
                                            label: _completedMonths.toString(),
                                            onChanged: _useAutoCalculation
                                                ? (value) => setState(
                                                      () => _completedMonths =
                                                          value.toInt(),
                                                    )
                                                : null,
                                          ),
                                        ),
                                      ],
                                    ),
                                    SizedBox(height: context.spacing16),

                                    // Á¥ØËÆ°Êî∂ÂÖ•ÂíåÁ®éË¥πËæìÂÖ•
                                    Text(
                                      'Á¥ØËÆ°Êî∂ÂÖ•ÂíåÁ®éË¥π',
                                      style: Theme.of(context)
                                          .textTheme
                                          .bodyLarge
                                          ?.copyWith(
                                            fontWeight: FontWeight.w500,
                                          ),
                                    ),
                                    SizedBox(height: context.spacing8),
                                    Row(
                                      children: [
                                        Expanded(
                                          child: AmountInputField(
                                            controller:
                                                _cumulativeIncomeController,
                                            labelText: 'Á¥ØËÆ°Êî∂ÂÖ•',
                                            hintText: 'ËØ∑ËæìÂÖ•Á¥ØËÆ°Êî∂ÂÖ•',
                                            prefixIcon: const Icon(
                                              Icons.account_balance,
                                              color: Colors.green,
                                            ),
                                          ),
                                        ),
                                        SizedBox(width: context.spacing12),
                                        Expanded(
                                          child: AmountInputField(
                                            controller:
                                                _cumulativeTaxController,
                                            labelText: 'Á¥ØËÆ°Á®éË¥π',
                                            hintText: 'ËØ∑ËæìÂÖ•Á¥ØËÆ°Á®éË¥π',
                                            prefixIcon: const Icon(
                                              Icons.calculate,
                                              color: Colors.red,
                                            ),
                                          ),
                                        ),
                                      ],
                                    ),
                                  ],
                                ),
                              ),
                            ),
                          ),
                          SizedBox(height: context.spacing16),
                        ],
                        
                        // Salary History Section
                        SalaryHistoryWidget(
                          basicSalaryController: _basicSalaryController,
                          salaryHistory: _salaryHistory,
                          onHistoryChanged: (history) =>
                              setState(() => _salaryHistory.addAll(history)),
                        ),

                        SizedBox(height: context.spacing16),
                        
                        // Navigation buttons
                        _buildNavigationButtons(),
                      ] else if (_currentStep == SetupStep.bonusSetup) ...[
                        // Bonus Management Section
                        BonusManagementWidget(
                          bonuses: _bonuses,
                          onBonusesChanged: (bonuses) {
                            print('üìù onBonusesChanged called with ${bonuses.length} bonuses');
                            for (var i = 0; i < bonuses.length; i++) {
                              final bonus = bonuses[i];
                              print('  Bonus ${i + 1}: ${bonus.name} - ${bonus.quarterlyPaymentMonths}');
                            }
                            setState(() {
                              _bonuses.clear();
                              _bonuses.addAll(bonuses);
                            });
                          },
                        ),
                        
                        SizedBox(height: context.spacing16),
                        
                        // Navigation buttons
                        _buildNavigationButtons(),
                      ] else if (_currentStep == SetupStep.allowanceAdjustment) ...[
                        // Monthly Allowance Adjustment Section
                        MonthlyAllowanceAdjustmentWidget(
                          defaultAllowances: AllowanceRecord.defaultAllowance(
                            housingAllowance:
                                double.tryParse(_housingAllowanceController.text) ?? 0,
                            mealAllowance:
                                double.tryParse(_mealAllowanceController.text) ?? 0,
                            transportationAllowance:
                                double.tryParse(_transportationAllowanceController.text) ?? 0,
                            otherAllowance:
                                double.tryParse(_otherAllowanceController.text) ?? 0,
                          ),
                          monthlyAllowances: _monthlyAllowances,
                          onAllowancesChanged: (allowances) {
                            setState(() {
                              _monthlyAllowances.clear();
                              _monthlyAllowances.addAll(allowances);
                            });
                          },
                        ),
                        
                        SizedBox(height: context.spacing16),
                        
                        // Navigation buttons
                        _buildNavigationButtons(),
                      ] else if (_currentStep == SetupStep.preview) ...[
                        // Tax and Deductions Section
                        TaxDeductionsWidget(
                          socialInsuranceController: _socialInsuranceController,
                          housingFundController: _housingFundController,
                          otherDeductionsController: _otherDeductionsController,
                          specialDeductionController: _specialDeductionController,
                          otherTaxFreeIncomeController: _otherTaxFreeIncomeController,
                          otherTaxDeductionsController: _otherTaxDeductionsController, // ÂÖ∂‰ªñÁ®éÊî∂Êâ£Èô§
                          specialDeductionMonthly: _specialDeductionMonthly,
                          onSpecialDeductionChanged: _onSpecialDeductionChanged,
                        ),

                        SizedBox(height: context.spacing24),

                        // Preview Button
                        Center(
                          child: ElevatedButton.icon(
                            onPressed: _navigateToTaxCalculationMode,
                            icon: const Icon(Icons.preview),
                            label: const Text('È¢ÑËßàÂ∑•ËµÑÊ†∏ÁÆó'),
                            style: ElevatedButton.styleFrom(
                              padding: EdgeInsets.symmetric(
                                horizontal: context.spacing24,
                                vertical: context.spacing12,
                              ),
                              backgroundColor: Colors.blue,
                              foregroundColor: Colors.white,
                              shape: RoundedRectangleBorder(
                                borderRadius: BorderRadius.circular(8),
                              ),
                            ),
                          ),
                        ),
                      ],
                  ),
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildStepIndicator(String title, bool isCompleted) {
    return Column(
      children: [
        Container(
          width: 32,
          height: 32,
          decoration: BoxDecoration(
            shape: BoxShape.circle,
            color: isCompleted ? Colors.blue : Colors.grey[300],
          ),
          child: Icon(
            isCompleted ? Icons.check : Icons.circle,
            color: Colors.white,
            size: 16,
          ),
        ),
        SizedBox(height: 4),
        Text(
          title,
          style: const TextStyle(
            fontSize: 12,
            color: Colors.grey,
            fontWeight: FontWeight.normal,
          ),
        ),
      ],
    );
  }

  Widget _buildStepConnector() {
    return Container(
      width: 40,
      color: Colors.grey[300],
      margin: const EdgeInsets.symmetric(horizontal: 8),
    );
                ],
              ),
            ),
          ],
        ),
      ),  }

  Widget _buildNavigationButtons() {
    return Row(
      children: [
        if (_currentStep != SetupStep.basicInfo) ...[
          Expanded(
            child: OutlinedButton(
              onPressed: _previousStep,
              child: const Text('‰∏ä‰∏ÄÊ≠•'),
            ),
          ),
          const SizedBox(width: 16),
        ],
        Expanded(
          child: ElevatedButton(
            onPressed: _currentStep == SetupStep.preview
                ? _navigateToTaxCalculationMode
                : _nextStep,
            child: Text(_currentStep == SetupStep.preview ? 'È¢ÑËßàÊî∂ÂÖ•' : '‰∏ã‰∏ÄÊ≠•'),
          ),
        ),
      ],
    );
  }

  void _nextStep() {
    setState(() {
      switch (_currentStep) {
        case SetupStep.basicInfo:
          _currentStep = SetupStep.bonusSetup;
          break;
        case SetupStep.bonusSetup:
          _currentStep = SetupStep.allowanceAdjustment;
          break;
        case SetupStep.allowanceAdjustment:
          _currentStep = SetupStep.preview;
          break;
        case SetupStep.preview:
          // Â∑≤ÁªèÊòØÊúÄÂêé‰∏ÄÊ≠•
          break;
      }
    });
  }

  void _previousStep() {
    setState(() {
      switch (_currentStep) {
        case SetupStep.basicInfo:
          // Â∑≤ÁªèÊòØÁ¨¨‰∏ÄÊ≠•
          break;
        case SetupStep.bonusSetup:
          _currentStep = SetupStep.basicInfo;
          break;
        case SetupStep.allowanceAdjustment:
          _currentStep = SetupStep.bonusSetup;
          break;
        case SetupStep.preview:
          _currentStep = SetupStep.allowanceAdjustment;
          break;
      }
    });
  }
}