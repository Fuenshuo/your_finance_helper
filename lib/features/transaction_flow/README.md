# Transaction Flow 功能模块文档

## 概述

`transaction_flow` 模块是三层架构中的第三层：**交易流水**。它负责管理实际交易执行，包括交易记录、智能关联、交易查询等功能。

## 模块定位

**核心理念**: 实际执行（交易记录、智能关联）

**职责边界**:
- ✅ 交易记录的完整展示
- ✅ 添加、编辑、删除交易
- ✅ 与财务计划的智能关联
- ✅ 重复交易的智能建议
- ✅ 交易搜索和筛选
- ✅ 交易时间线展示
- ❌ 不涉及静态数据管理（属于family_info）
- ❌ 不涉及规则配置（属于financial_planning）

## 包结构

```
transaction_flow/
├── screens/          # 页面界面
├── widgets/          # 专用组件
└── services/         # 专用服务
```

## Screens 页面说明

### 1. transaction_flow_home_screen.dart - 交易流水主页

**职责**: 提供交易流水的统一入口

**功能**:
- 模块介绍
- 交易总览统计
- 最近交易列表（包含"查看全部"按钮，可跳转到交易记录页面）
- AI智能记账入口（替换了原来的"交易记录"按钮）
- 快速添加交易入口

**导航**:
- AI智能记账 → `ai_smart_accounting_widget.dart`（显示AI功能选择对话框）
- 添加交易 → `add_transaction_screen.dart`
- 查看全部 → `transaction_records_screen.dart`（通过最近交易区域的"查看全部"按钮）
- 交易详情 → `transaction_detail_screen.dart`

### 2. add_transaction_screen.dart - 添加交易页面

**职责**: 创建和编辑交易记录

**功能**:
- 交易类型选择（收入、支出、转账）
- 交易基本信息（描述、金额、日期）
- 账户选择（支出账户、收入账户、转账账户）
- 分类选择（交易分类、子分类）
- 预算关联（信封预算、支出计划）
- 交易标签和备注
- 草稿保存
- 重复交易标记

**交易类型**:
- **收入**: 从账户收款
- **支出**: 从账户扣款
- **转账**: 账户间转账

**智能功能**:
- 自动关联预算
- 重复交易建议
- 账户余额更新
- **AI智能记账**（新增）
  - 自然语言输入：用户通过自然语言描述交易，AI自动解析并填充表单
  - 发票识别：拍照识别发票/收据，自动提取交易信息

**参数**:
- `parsedTransaction`: AI解析后的交易数据（可选）
- `imagePath`: 交易关联的图片路径（可选，用于发票识别）

### 3. transaction_records_screen.dart - 交易记录页面

**职责**: 展示所有交易记录

**功能**:
- 交易列表展示（按日期分组）
- 交易搜索
- 交易筛选（类型、分类、账户、日期范围）
- 交易排序
- 批量操作（删除、标记）
- 交易详情查看

**列表样式**:
- 使用圆形图标阴影卡片样式
- 支持滑动删除
- 支持批量选择

### 4. transaction_list_screen.dart - 交易列表页面

**职责**: 展示交易列表（按日期分组）

**功能**:
- 日期分组展示
- 每日交易汇总
- 交易项展示
- 搜索高亮
- 批量选择

**列表样式**:
- 使用分组头像卡片样式
- 支持日期分组
- 支持搜索高亮动效

### 5. transaction_detail_screen.dart - 交易详情页面

**职责**: 展示交易详细信息

**功能**:
- 交易基本信息展示
- 账户信息
- 分类信息
- 预算关联信息
- 交易标签和备注
- 编辑和删除操作
- 交易历史记录

### 6. transaction_management_screen.dart - 交易管理页面

**职责**: 综合交易管理界面

**功能**:
- 总览标签页（交易统计）
- 交易记录标签页
- 草稿标签页
- 批量操作
- 交易筛选和搜索

**标签页**:
- 总览: 交易统计和图表
- 交易记录: 所有已确认的交易
- 草稿: 未完成的交易草稿

## Widgets 组件说明

### 1. payment_timeline_widget.dart - 支付时间线组件

**职责**: 展示交易的时间线视图

**功能**:
- 时间线展示
- 交易节点展示
- 时间筛选
- 交易详情查看

### 2. natural_language_input_widget.dart - 自然语言输入组件（新增）

**职责**: 提供自然语言记账功能

**功能**:
- 自然语言输入框
- AI解析交易信息
- 实时显示解析结果预览
- 一键填充表单
- 解析状态反馈

**使用场景**:
- 快速记账：用户输入"今天在星巴克买了杯拿铁，花了35块，用的支付宝"
- AI自动提取：描述、金额、分类、账户、日期等信息
- 用户确认：显示解析结果，用户可修改后保存

### 3. invoice_recognition_widget.dart - 发票识别组件（新增）

**职责**: 提供发票/收据识别功能

**功能**:
- 拍照识别按钮
- 相册选择按钮
- 图片预览
- AI识别发票信息
- 识别结果展示
- 图片自动保存

**使用场景**:
- 发票识别：拍照或选择发票图片，AI自动识别商家、金额、日期等信息
- 收据识别：识别收据小票，自动提取交易信息
- 批量处理：支持连续识别多张发票

### 4. ai_smart_accounting_widget.dart - AI智能记账入口组件（新增）

**职责**: 提供AI智能记账的统一入口

**功能**:
- 显示AI功能选择对话框
- 支持两种AI记账模式：
  - 自然语言输入：语音输入交易描述
  - 发票识别：拍照识别发票/收据
- 模式切换（标签页式）
- 识别完成后自动导航到添加交易页面并预填充数据

**使用场景**:
- 从收支流水主页点击"AI智能记账"按钮
- 选择记账方式（自然语言或拍照）
- AI识别完成后自动填充表单
- 用户确认或修改后保存交易

**导航流程**:
1. 用户点击"AI智能记账"按钮
2. 显示底部对话框，选择记账模式
3. 使用AI功能识别交易信息
4. 识别完成后关闭对话框
5. 自动导航到添加交易页面，表单已预填充
6. 用户确认或修改后保存

## Services 服务说明

### 1. auto_transaction_service.dart - 自动交易服务

**职责**: 处理定期工资和奖金交易的自动生成

**功能**:
- 生成月度工资交易
- 生成奖金交易（年终奖、季度奖等）
- 处理工资计算（基本工资、津贴、扣除项）
- 处理奖金计算（不同类型奖金）
- 自动标记为自动生成交易

**触发时机**:
- 工资计划执行时
- 奖金计划执行时
- 手动触发生成

### 2. timeline_service.dart - 时间线服务

**职责**: 处理交易时间线相关逻辑

**功能**:
- 交易时间线构建
- 时间节点计算
- 时间线数据格式化

## 数据流

### 数据来源
- `core/providers/transaction_provider.dart` - 交易状态管理
- `core/providers/account_provider.dart` - 账户状态管理
- `core/providers/budget_provider.dart` - 预算状态管理
- `core/models/transaction.dart` - 交易模型
- `core/services/storage_service.dart` - 存储服务
- `core/services/drift_database_service.dart` - 数据库服务

### 数据流向
1. UI层（Screens） → Provider层（状态管理）
2. Provider层 → Service层（业务逻辑）
3. Service层 → Storage/Database层（数据持久化）
4. 交易创建 → 账户余额更新
5. 交易创建 → 预算使用情况更新

## 与其他模块的关系

### 与 Family Info 模块
- **输入**: 账户数据用于交易关联
- **输出**: 清账完成后生成交易记录

### 与 Financial Planning 模块
- **输入**: 计划执行时自动生成交易
- **输入**: 预算数据用于交易关联
- **输出**: 交易记录用于预算使用情况统计

## 核心功能

### 1. 交易记录管理

**交易创建**:
- 支持收入、支出、转账三种类型
- 完整的交易信息录入
- 账户余额自动更新
- 预算关联自动更新

**交易编辑**:
- 修改交易信息
- 更新账户余额
- 更新预算使用情况

**交易删除**:
- 删除交易记录
- 恢复账户余额
- 恢复预算使用情况

### 2. 智能关联

**预算关联**:
- 自动关联信封预算
- 自动关联支出计划
- 预算使用情况实时更新

**账户关联**:
- 交易自动关联账户
- 账户余额实时更新
- 账户交易历史记录

### 3. 重复交易建议

**智能识别**:
- 识别重复交易模式
- 基于金额、分类、账户匹配
- 基于时间间隔匹配

**建议功能**:
- 显示相似交易
- 一键创建重复交易
- 重复交易标记

### 4. 交易查询和筛选

**搜索功能**:
- 按描述搜索
- 按金额搜索
- 按账户搜索
- 按分类搜索

**筛选功能**:
- 按交易类型筛选
- 按交易分类筛选
- 按账户筛选
- 按日期范围筛选
- 按预算筛选

**排序功能**:
- 按日期排序
- 按金额排序
- 按账户排序

### 5. 交易时间线

**时间线展示**:
- 按时间顺序展示交易
- 时间节点标记
- 交易详情查看

**时间筛选**:
- 按日期范围筛选
- 按月份筛选
- 按年份筛选

## 设计原则

### 1. 用户无感知的复式记账
交易创建时自动处理账户余额和预算关联，用户无需手动操作。

### 2. 智能关联
自动关联预算和计划，减少用户配置工作。

### 3. 完整的交易信息
记录交易的完整信息，支持后续查询和分析。

### 4. 实时更新
交易创建、编辑、删除时实时更新相关数据。

## 使用指南

### 添加交易

1. 进入交易流水主页
2. 点击"添加交易"
3. 选择交易类型（收入、支出、转账）
4. 填写交易信息（描述、金额、日期）
5. 选择账户和分类
6. 关联预算（可选）
7. 添加标签和备注（可选）
8. 保存交易

### 查询交易

1. 进入交易记录页面
2. 使用搜索框搜索交易
3. 使用筛选器筛选交易
4. 使用排序功能排序交易
5. 点击交易查看详情

### 批量操作

1. 进入交易记录页面
2. 点击批量选择按钮
3. 选择要操作的交易
4. 执行批量操作（删除、标记等）

## 相关文档

- [Core包文档](../../core/README.md)
- [Financial Planning模块文档](../financial_planning/README.md)
- [项目架构重构总结](../../../项目架构重构总结.md)
- [列表样式指南](../../../LIST_STYLE_GUIDE.md)

