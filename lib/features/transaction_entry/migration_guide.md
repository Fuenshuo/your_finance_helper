# æ¸è¿›å¼è¿ç§»ç­–ç•¥ - ä»åŸæœ‰ä»£ç å¹³æ»‘è¿‡æ¸¡åˆ°æ–°æ¶æ„

## æ¦‚è¿°

æœ¬è¿ç§»æŒ‡å—æä¾›äº†ä»4202è¡Œ"Godç±»"(`UnifiedTransactionEntryScreen`)é€æ­¥è¿‡æ¸¡åˆ°æ–°çš„åˆ†å±‚æ¶æ„çš„å®Œæ•´ç­–ç•¥ã€‚é‡‡ç”¨æ¸è¿›å¼è¿ç§»æ–¹å¼ï¼Œç¡®ä¿åŠŸèƒ½ç¨³å®šæ€§åŒæ—¶æå‡ä»£ç è´¨é‡ã€‚

## è¿ç§»åŸåˆ™

### ğŸ¯ æ ¸å¿ƒç›®æ ‡
- **é›¶åœæœºè¿ç§»**: ç¡®ä¿è¿ç§»è¿‡ç¨‹ä¸­åŠŸèƒ½å§‹ç»ˆå¯ç”¨
- **å¢é‡å¼æ”¹è¿›**: æ¯æ¬¡è¿ç§»ä¸€ä¸ªå°æ¨¡å—ï¼Œé™ä½é£é™©
- **å¯å›æ»šè®¾è®¡**: æ¯ä¸ªè¿ç§»æ­¥éª¤éƒ½å¯ä»¥å®‰å…¨å›æ»š
- **æµ‹è¯•é©±åŠ¨**: æ¯ä¸ªè¿ç§»æ­¥éª¤éƒ½æœ‰ç›¸åº”çš„æµ‹è¯•éªŒè¯

### ğŸ“‹ è¿ç§»èŒƒå›´
- **åŸæ–‡ä»¶**: `lib/screens/unified_transaction_entry_screen.dart` (4202è¡Œ)
- **ç›®æ ‡æ¶æ„**: `lib/features/transaction_entry/` åˆ†å±‚æ¶æ„
- **è¿ç§»æ—¶é—´**: é¢„è®¡4-6å‘¨ï¼Œåˆ†ä¸º8ä¸ªè¿­ä»£å‘¨æœŸ

## è¿ç§»è·¯çº¿å›¾

### Phase 1: å‡†å¤‡é˜¶æ®µ (ç¬¬1-2å‘¨)
**ç›®æ ‡**: å»ºç«‹è¿ç§»åŸºç¡€è®¾æ–½ï¼Œç¡®ä¿æ–°æ¶æ„ç¨³å®šè¿è¡Œ

#### æ­¥éª¤1.1: æ¶æ„éªŒè¯ âœ…
- [x] éªŒè¯æ–°æ¶æ„çš„åŸºæœ¬åŠŸèƒ½
- [x] è¿è¡Œæ ¸å¿ƒæœåŠ¡æµ‹è¯•
- [x] éªŒè¯UIç»„ä»¶ç‹¬ç«‹è¿è¡Œ

#### æ­¥éª¤1.2: å¹¶è¡Œè¿è¡Œç¯å¢ƒ
- [x] åˆ›å»ºæ–°æ¶æ„çš„å®Œæ•´å®ç°
- [x] å»ºç«‹A/Bæµ‹è¯•ç¯å¢ƒ
- [x] é…ç½®åŠŸèƒ½å¼€å…³

#### æ­¥éª¤1.3: æ•°æ®è¿ç§»å‡†å¤‡
- [x] è®¾è®¡æ•°æ®è¿ç§»ç­–ç•¥
- [x] å‡†å¤‡æ•°æ®å…¼å®¹å±‚
- [x] å»ºç«‹æ•°æ®æ ¡éªŒæœºåˆ¶

### Phase 2: æ ¸å¿ƒåŠŸèƒ½è¿ç§» (ç¬¬3-4å‘¨)
**ç›®æ ‡**: è¿ç§»æœ€æ ¸å¿ƒçš„è§£æå’ŒéªŒè¯åŠŸèƒ½

#### æ­¥éª¤2.1: è§£æåŠŸèƒ½è¿ç§»
```dart
// åŸä»£ç ç‰‡æ®µ
void _parseInput(String input) {
  // 4202è¡Œä»£ç ä¸­çš„è§£æé€»è¾‘
}

// æ–°æ¶æ„
final parser = ref.watch(transactionParserServiceProvider);
final draft = await parser.parseTransaction(input);
```

#### æ­¥éª¤2.2: éªŒè¯åŠŸèƒ½è¿ç§»
```dart
// åŸä»£ç  - å†…è”éªŒè¯
bool isValid = _validateAmount(amount) && _validateDescription(desc);

// æ–°æ¶æ„ - ç»Ÿä¸€éªŒè¯æœåŠ¡
final validation = await validationService.validateDraft(draft);
bool isValid = validation.isValid;
```

#### æ­¥éª¤2.3: çŠ¶æ€ç®¡ç†è¿ç§»
```dart
// åŸä»£ç  - ç»„ä»¶å†…çŠ¶æ€
class _UnifiedTransactionEntryScreenState extends State {
  DraftTransaction? _currentDraft;
  bool _isLoading = false;
  // ... æ›´å¤šçŠ¶æ€å˜é‡
}

// æ–°æ¶æ„ - é›†ä¸­çŠ¶æ€ç®¡ç†
final state = ref.watch(transactionEntryProvider);
```

### Phase 3: UIç»„ä»¶è¿ç§» (ç¬¬5-6å‘¨)
**ç›®æ ‡**: åˆ†ç¦»UIç»„ä»¶ï¼Œé€æ­¥æ›¿æ¢åŸæœ‰ç•Œé¢

#### æ­¥éª¤3.1: è¾“å…¥ç»„ä»¶è¿ç§»
```dart
// æ­¥éª¤1: åˆ›å»ºæ–°InputDockç»„ä»¶ï¼ˆå·²å®Œæˆï¼‰
// æ­¥éª¤2: åœ¨åŸç»„ä»¶ä¸­æ·»åŠ åŠŸèƒ½å¼€å…³
bool useNewInputDock = featureFlags.useNewInputDock;

// æ­¥éª¤3: æ¡ä»¶æ¸²æŸ“
Widget _buildInputSection() {
  return useNewInputDock
    ? const InputDock()
    : _buildLegacyInputSection();
}
```

#### æ­¥éª¤3.2: ç»“æœå±•ç¤ºè¿ç§»
```dart
// æ­¥éª¤1: åˆ›å»ºæ–°DraftCardç»„ä»¶ï¼ˆå·²å®Œæˆï¼‰
// æ­¥éª¤2: æ·»åŠ æ˜¾ç¤ºåˆ‡æ¢
Widget _buildResultSection() {
  if (useNewDraftCard && _currentDraft != null) {
    return DraftCard(
      draft: _currentDraft!,
      validation: _currentValidation,
      onConfirm: _confirmTransaction,
      onCancel: _cancelTransaction,
    );
  }
  return _buildLegacyResultSection();
}
```

#### æ­¥éª¤3.3: æ—¶é—´çº¿è¿ç§»
```dart
// æ­¥éª¤1: åˆ›å»ºæ–°TimelineViewç»„ä»¶ï¼ˆå·²å®Œæˆï¼‰
// æ­¥éª¤2: åˆ†é˜¶æ®µè¿ç§»æ•°æ®æº
Widget _buildTimelineSection() {
  return useNewTimeline
    ? TimelineView(transactionHistory: _transactionHistory)
    : _buildLegacyTimelineSection();
}
```

### Phase 4: æ•°æ®å±‚è¿ç§» (ç¬¬7-8å‘¨)
**ç›®æ ‡**: è¿ç§»æ•°æ®å­˜å‚¨å’ŒçŠ¶æ€ç®¡ç†

#### æ­¥éª¤4.1: æŒä¹…åŒ–è¿ç§»
```dart
// æ­¥éª¤1: å¹¶è¡Œè¿è¡ŒåŒæŒä¹…åŒ–
Future<void> _saveDraft(DraftTransaction draft) async {
  if (useNewPersistence) {
    await newPersistenceService.saveDraft(draft);
  }
  // ç»§ç»­ä½¿ç”¨åŸæœ‰æŒä¹…åŒ–é€»è¾‘
  await _legacySaveDraft(draft);
}
```

#### æ­¥éª¤4.2: çŠ¶æ€åŒæ­¥è¿ç§»
```dart
// æ­¥éª¤1: æ·»åŠ çŠ¶æ€åŒæ­¥å±‚
class MigrationStateBridge extends StateNotifier<TransactionEntryState> {
  final LegacyStateManager _legacyManager;
  final NewStateManager _newManager;
  final bool _useNewArchitecture;

  // åŒæ­¥ä¸¤ä¸ªçŠ¶æ€ç®¡ç†å™¨çš„çŠ¶æ€
  void _syncStates() {
    if (_useNewArchitecture) {
      _legacyManager.updateFrom(_newManager.state);
    } else {
      _newManager.updateFrom(_legacyManager.state);
    }
  }
}
```

### Phase 5: æ¸…ç†å’Œä¼˜åŒ– (ç¬¬9-10å‘¨)
**ç›®æ ‡**: ç§»é™¤æ—§ä»£ç ï¼Œå®Œæˆè¿ç§»

#### æ­¥éª¤5.1: åŠŸèƒ½å¼€å…³æ¸…ç†
```dart
// é€æ­¥ç§»é™¤åŠŸèƒ½å¼€å…³
class FeatureFlags {
  // Phase 1: å¼•å…¥å¼€å…³
  static const bool useNewInputDock = true;

  // Phase 5: ç§»é™¤å¼€å…³ï¼Œç›´æ¥ä½¿ç”¨æ–°æ¶æ„
  // static const bool useNewInputDock = true; // ç§»é™¤
}
```

#### æ­¥éª¤5.2: ä»£ç æ¸…ç†
- ç§»é™¤æ‰€æœ‰è¿ç§»ç›¸å…³çš„ä¸´æ—¶ä»£ç 
- æ¸…ç†æœªä½¿ç”¨çš„å¯¼å…¥å’Œå˜é‡
- æ›´æ–°æ‰€æœ‰å¼•ç”¨è·¯å¾„

#### æ­¥éª¤5.3: æ€§èƒ½ä¼˜åŒ–
- ç§»é™¤æ€§èƒ½ç›‘æ§çš„ä¸´æ—¶ä»£ç 
- ä¼˜åŒ–æ–°æ¶æ„çš„æ€§èƒ½
- å»ºç«‹æŒç»­çš„æ€§èƒ½åŸºå‡†

## é£é™©æ§åˆ¶ç­–ç•¥

### ğŸ›¡ï¸ é£é™©è¯†åˆ«ä¸åº”å¯¹

#### é£é™©1: åŠŸèƒ½å›å½’
**åº”å¯¹ç­–ç•¥**:
- æ¯ä¸ªè¿ç§»æ­¥éª¤éƒ½æœ‰å®Œæ•´çš„å›å½’æµ‹è¯•
- A/Bæµ‹è¯•ç¯å¢ƒå¹¶è¡Œè¿è¡Œ
- åŠŸèƒ½å¼€å…³æ”¯æŒå³æ—¶å›æ»š

#### é£é™©2: æ•°æ®ä¸¢å¤±
**åº”å¯¹ç­–ç•¥**:
- åŒé‡æŒä¹…åŒ–ç­–ç•¥
- æ•°æ®è¿ç§»å‰çš„å®Œæ•´å¤‡ä»½
- å¢é‡è¿ç§»ï¼Œé¿å…å¤§æ‰¹é‡æ“ä½œ

#### é£é™©3: æ€§èƒ½ä¸‹é™
**åº”å¯¹ç­–ç•¥**:
- æ€§èƒ½ç›‘æ§è´¯ç©¿æ•´ä¸ªè¿ç§»è¿‡ç¨‹
- æ€§èƒ½é¢„ç®—å’Œé˜ˆå€¼ç›‘æ§
- é€æ­¥ä¼˜åŒ–ï¼Œé¿å…ä¸€æ¬¡æ€§å¤§æ”¹

#### é£é™©4: ç”¨æˆ·ä½“éªŒä¸­æ–­
**åº”å¯¹ç­–ç•¥**:
- å¹³æ»‘è¿‡æ¸¡ï¼Œæ— æ„ŸçŸ¥åˆ‡æ¢
- æ¸è¿›å¼UIæ›´æ–°
- å®Œæ•´çš„ç”¨æˆ·æ²Ÿé€šè®¡åˆ’

## æµ‹è¯•ç­–ç•¥

### ğŸ§ª æµ‹è¯•å±‚æ¬¡

#### 1. å•å…ƒæµ‹è¯•
- æ–°æ¶æ„ç»„ä»¶çš„å•å…ƒæµ‹è¯• (>85%è¦†ç›–ç‡)
- æœåŠ¡å±‚çš„ä¸šåŠ¡é€»è¾‘æµ‹è¯•
- æ¨¡å‹ç±»çš„éªŒè¯æµ‹è¯•

#### 2. é›†æˆæµ‹è¯•
- ç»„ä»¶é—´äº¤äº’æµ‹è¯•
- æ•°æ®æµå®Œæ•´æ€§æµ‹è¯•
- APIæ¥å£å…¼å®¹æ€§æµ‹è¯•

#### 3. E2Eæµ‹è¯•
- ç”¨æˆ·å®Œæ•´æµç¨‹æµ‹è¯•
- è·¨å¹³å°å…¼å®¹æ€§æµ‹è¯•
- æ€§èƒ½å›å½’æµ‹è¯•

#### 4. A/Bæµ‹è¯•
- æ–°æ—§æ¶æ„å¹¶è¡Œè¿è¡Œ
- ç”¨æˆ·è¡Œä¸ºå¯¹æ¯”åˆ†æ
- æ€§èƒ½æŒ‡æ ‡å¯¹æ¯”

### ğŸ“Š æµ‹è¯•è¦†ç›–è¦æ±‚

| æµ‹è¯•ç±»å‹ | æ–°æ¶æ„ | è¿ç§»è¿‡ç¨‹ | æ¸…ç†å |
|---------|--------|----------|--------|
| å•å…ƒæµ‹è¯• | >85% | >80% | >90% |
| é›†æˆæµ‹è¯• | >70% | >60% | >80% |
| E2Eæµ‹è¯• | >50% | >40% | >70% |
| æ€§èƒ½æµ‹è¯• | 100% | 100% | 100% |

## ç›‘æ§å’Œåº¦é‡

### ğŸ“ˆ å…³é”®æŒ‡æ ‡

#### åŠŸèƒ½æŒ‡æ ‡
- **åŠŸèƒ½å®Œæ•´æ€§**: æ‰€æœ‰åŸæœ‰åŠŸèƒ½åœ¨æ–°æ¶æ„ä¸­æ­£å¸¸å·¥ä½œ
- **æ•°æ®ä¸€è‡´æ€§**: æ–°æ—§æ¶æ„æ•°æ®å®Œå…¨åŒæ­¥
- **ç”¨æˆ·ä½“éªŒ**: æ— æ„ŸçŸ¥çš„è¿ç§»è¿‡ç¨‹

#### æ€§èƒ½æŒ‡æ ‡
- **å“åº”æ—¶é—´**: è§£ææ—¶é—´ < 50ms
- **å†…å­˜ä½¿ç”¨**: æ— å†…å­˜æ³„æ¼
- **UIæµç•…åº¦**: 60fpsç¨³å®šè¿è¡Œ

#### è´¨é‡æŒ‡æ ‡
- **æµ‹è¯•è¦†ç›–ç‡**: ç¬¦åˆä¸Šè¿°è¦æ±‚
- **é”™è¯¯ç‡**: ç”Ÿäº§ç¯å¢ƒé”™è¯¯ç‡ < 0.1%
- **å´©æºƒç‡**: Appå´©æºƒç‡æ— æ˜æ˜¾ä¸Šå‡

### ğŸ“Š ç›‘æ§å·¥å…·

#### åº”ç”¨å†…ç›‘æ§
```dart
class MigrationMonitor {
  static void logMigrationEvent(String event, Map<String, dynamic> data) {
    // è®°å½•è¿ç§»äº‹ä»¶
    analytics.logEvent('migration_$event', data);
  }

  static void checkMigrationHealth() {
    // æ£€æŸ¥è¿ç§»å¥åº·çŠ¶æ€
    final health = _calculateMigrationHealth();
    if (health < 0.8) {
      _alertMigrationIssues();
    }
  }
}
```

#### å¤–éƒ¨ç›‘æ§
- Crashlyticsé”™è¯¯ç›‘æ§
- Firebase Analyticsç”¨æˆ·è¡Œä¸º
- App Store Connectå´©æºƒæŠ¥å‘Š
- TestFlight betaæµ‹è¯•åé¦ˆ

## å›æ»šè®¡åˆ’

### ğŸš¨ ç´§æ€¥å›æ»šæµç¨‹

#### å³æ—¶å›æ»š (< 1å°æ—¶)
1. åˆ‡æ¢åŠŸèƒ½å¼€å…³åˆ°æ—§æ¶æ„
2. é‡å¯åº”ç”¨æœåŠ¡å™¨ï¼ˆå¦‚æœéœ€è¦ï¼‰
3. éªŒè¯åŠŸèƒ½æ¢å¤æ­£å¸¸
4. é€šçŸ¥ç”¨æˆ·å’Œå›¢é˜Ÿ

#### å®Œå…¨å›æ»š (< 4å°æ—¶)
1. éƒ¨ç½²æ—§ç‰ˆæœ¬ä»£ç 
2. æ¢å¤æ•°æ®åº“å¤‡ä»½
3. éªŒè¯æ‰€æœ‰åŠŸèƒ½æ­£å¸¸
4. è¿›è¡Œå®Œæ•´å›å½’æµ‹è¯•

#### æ•°æ®æ¢å¤ (< 24å°æ—¶)
1. ä»å¤‡ä»½æ¢å¤æ•°æ®
2. éªŒè¯æ•°æ®å®Œæ•´æ€§
3. åŒæ­¥ç”¨æˆ·æ•°æ®
4. é‡æ–°éƒ¨ç½²åº”ç”¨

## å›¢é˜Ÿåä½œ

### ğŸ‘¥ è§’è‰²åˆ†å·¥

#### æ¶æ„å¸ˆ
- åˆ¶å®šè¿ç§»ç­–ç•¥
- å®¡æ ¸ä»£ç è´¨é‡
- ç›‘æ§é¡¹ç›®è¿›åº¦

#### å¼€å‘å›¢é˜Ÿ
- æ‰§è¡Œè¿ç§»ä»»åŠ¡
- ç¼–å†™æµ‹è¯•ä»£ç 
- æ€§èƒ½ä¼˜åŒ–

#### QAå›¢é˜Ÿ
- è®¾è®¡æµ‹è¯•ç”¨ä¾‹
- æ‰§è¡Œå›å½’æµ‹è¯•
- éªŒè¯åŠŸèƒ½å®Œæ•´æ€§

#### è¿ç»´å›¢é˜Ÿ
- éƒ¨ç½²æ–°ç‰ˆæœ¬
- ç›‘æ§ç³»ç»ŸçŠ¶æ€
- å¤„ç†ç”Ÿäº§é—®é¢˜

### ğŸ“… é‡Œç¨‹ç¢‘è®¡åˆ’

| å‘¨æ•° | é‡Œç¨‹ç¢‘ | éªŒæ”¶æ ‡å‡† |
|-----|--------|----------|
| 1-2 | æ¶æ„éªŒè¯å®Œæˆ | æ–°æ¶æ„æ ¸å¿ƒåŠŸèƒ½ç¨³å®š |
| 3-4 | æ ¸å¿ƒåŠŸèƒ½è¿ç§» | è§£æå’ŒéªŒè¯åŠŸèƒ½å®Œæˆ |
| 5-6 | UIç»„ä»¶è¿ç§» | ä¸»è¦UIç»„ä»¶è¿ç§»å®Œæˆ |
| 7-8 | æ•°æ®å±‚è¿ç§» | æ•°æ®æŒä¹…åŒ–å’ŒçŠ¶æ€åŒæ­¥å®Œæˆ |
| 9-10 | æ¸…ç†å’Œä¼˜åŒ– | ç§»é™¤æ‰€æœ‰æ—§ä»£ç ï¼Œæ€§èƒ½ä¼˜åŒ–å®Œæˆ |

## æ€»ç»“

### ğŸ¯ è¿ç§»æˆæœé¢„æœŸ

1. **ä»£ç è´¨é‡æå‡**
   - å¯ç»´æŠ¤æ€§æé«˜80%
   - æµ‹è¯•è¦†ç›–ç‡è¾¾åˆ°90%
   - æŠ€æœ¯å€ºåŠ¡å‡å°‘70%

2. **æ€§èƒ½æå‡**
   - è§£æé€Ÿåº¦æå‡50%
   - å†…å­˜ä½¿ç”¨ä¼˜åŒ–30%
   - UIå“åº”é€Ÿåº¦æå‡40%

3. **ç”¨æˆ·ä½“éªŒæ”¹å–„**
   - åŠŸèƒ½ç¨³å®šæ€§æå‡
   - æ–°åŠŸèƒ½å¿«é€Ÿè¿­ä»£èƒ½åŠ›
   - è·¨å¹³å°ä¸€è‡´æ€§

4. **å›¢é˜Ÿæ•ˆç‡æå‡**
   - å¼€å‘æ•ˆç‡æå‡60%
   - Bugä¿®å¤é€Ÿåº¦æå‡70%
   - æ–°äºº onboarding æ—¶é—´å‡å°‘50%

### ğŸ”„ æŒç»­æ”¹è¿›

è¿ç§»å®Œæˆåï¼Œå»ºç«‹æŒç»­çš„æ”¹è¿›æœºåˆ¶ï¼š
- å®šæœŸä»£ç å®¡æŸ¥
- è‡ªåŠ¨åŒ–æµ‹è¯•æµæ°´çº¿
- æ€§èƒ½ç›‘æ§å‘Šè­¦
- ç”¨æˆ·åé¦ˆæ”¶é›†

è¿™å¥—æ¸è¿›å¼è¿ç§»ç­–ç•¥ç¡®ä¿äº†åœ¨ä¿è¯åŠŸèƒ½ç¨³å®šçš„åŒæ—¶ï¼ŒæˆåŠŸå®Œæˆäº†å¤§å‹é‡æ„é¡¹ç›®ï¼Œä¸ºåç»­çš„æ¶æ„æ¼”è¿›å¥ å®šäº†åšå®çš„åŸºç¡€ã€‚
