# 家庭资产记账应用 - 数据存储架构与格式说明

## 概述

本文档详细描述了家庭资产记账应用的数据存储架构、格式规范、迁移策略以及状态管理机制。应用采用了现代化的数据持久化方案，结合关系型数据库（Drift/SQLite）、键值存储（SharedPreferences）和状态管理框架（Riverpod/Provider）。

## 架构概览

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Riverpod      │    │     Provider     │    │   UI Layer      │
│  State Mgmt     │    │  State Mgmt      │    │   (Screens)     │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         └───────────────────────┼───────────────────────┘
                                 │
                    ┌─────────────────┐
                    │  Drift Service  │
                    │   (Type-safe    │
                    │   SQLite ORM)   │
                    └─────────────────┘
                             │
                    ┌─────────────────┐
                    │   SQLite DB     │
                    │ (app_database.db)
                    └─────────────────┘
```

## 数据存储层次

### 1. 主数据库 (Drift/SQLite)

#### 位置
```
~/Library/Developer/CoreSimulator/Devices/[DEVICE_ID]/data/Containers/Data/Application/[APP_ID]/Documents/app_database.db
```

#### 表结构概览

```sql
-- 资产表
CREATE TABLE "assets" (
    "id" TEXT NOT NULL,
    "name" TEXT NOT NULL,
    "amount" REAL NOT NULL,
    "category" TEXT NOT NULL,
    "sub_category" TEXT NOT NULL,
    "creation_date" INTEGER NOT NULL,
    "update_date" INTEGER NOT NULL,
    "purchase_date" INTEGER NULL,
    "depreciation_method" TEXT NULL,
    "depreciation_rate" REAL NULL,
    "current_value" REAL NULL,
    "is_idle" INTEGER NOT NULL DEFAULT 0,
    "idle_value" REAL NULL,
    "notes" TEXT NULL,
    PRIMARY KEY ("id")
);

-- 交易记录表
CREATE TABLE "transactions" (
    "id" TEXT NOT NULL,
    "description" TEXT NOT NULL,
    "amount" REAL NOT NULL,
    "flow" TEXT NULL,
    "type" TEXT NULL,
    "category" TEXT NOT NULL,
    "sub_category" TEXT NULL,
    "from_wallet_id" TEXT NULL,
    "to_wallet_id" TEXT NULL,
    "from_asset_id" TEXT NULL,
    "to_asset_id" TEXT NULL,
    "from_account_id" TEXT NULL,
    "to_account_id" TEXT NULL,
    "envelope_budget_id" TEXT NULL,
    "date" INTEGER NOT NULL,
    "notes" TEXT NULL,
    "tags" TEXT NOT NULL,
    "status" TEXT NOT NULL,
    "is_recurring" INTEGER NOT NULL DEFAULT 0,
    "recurring_rule" TEXT NULL,
    "parent_transaction_id" TEXT NULL,
    "creation_date" INTEGER NOT NULL,
    "update_date" INTEGER NOT NULL,
    "image_path" TEXT NULL,
    "is_auto_generated" INTEGER NOT NULL DEFAULT 0,
    PRIMARY KEY ("id")
);

-- 账户表
CREATE TABLE "accounts" (
    "id" TEXT NOT NULL,
    "name" TEXT NOT NULL,
    "description" TEXT NULL,
    "type" TEXT NOT NULL,
    "status" TEXT NOT NULL,
    "balance" REAL NOT NULL,
    "initial_balance" REAL NOT NULL DEFAULT 0.0,
    "currency" TEXT NOT NULL DEFAULT 'CNY',
    "bank_name" TEXT NULL,
    "account_number" TEXT NULL,
    "card_number" TEXT NULL,
    "credit_limit" REAL NULL,
    "interest_rate" REAL NULL,
    "open_date" INTEGER NULL,
    "close_date" INTEGER NULL,
    "loan_type" TEXT NULL,
    "loan_amount" REAL NULL,
    "second_interest_rate" NULL,
    "loan_term" INTEGER NULL,
    "repayment_method" TEXT NULL,
    "first_payment_date" INTEGER NULL,
    "remaining_principal" REAL NULL,
    "monthly_payment" REAL NULL,
    "is_recurring_payment" INTEGER NOT NULL DEFAULT 0,
    "icon_name" TEXT NULL,
    "color" TEXT NULL,
    "is_default" INTEGER NOT NULL DEFAULT 0,
    "is_hidden" INTEGER NOT NULL DEFAULT 0,
    "tags" TEXT NOT NULL,
    "creation_date" INTEGER NOT NULL,
    "update_date" INTEGER NOT NULL,
    "sync_provider" TEXT NULL,
    "sync_account_id" TEXT NULL,
    "last_sync_date" INTEGER NULL,
    PRIMARY KEY ("id")
);

-- 信封预算表
CREATE TABLE "envelope_budgets" (
    "id" TEXT NOT NULL,
    "name" TEXT NOT NULL,
    "description" TEXT NULL,
    "category" TEXT NOT NULL,
    "allocated_amount" REAL NOT NULL,
    "spent_amount" REAL NOT NULL DEFAULT 0.0,
    "period" TEXT NOT NULL,
    "start_date" INTEGER NOT NULL,
    "end_date" INTEGER NOT NULL,
    "status" TEXT NOT NULL,
    "color" TEXT NULL,
    "icon_name" TEXT NULL,
    "is_essential" INTEGER NOT NULL DEFAULT 0,
    "warning_threshold" REAL NULL,
    "limit_threshold" REAL NULL,
    "tags" TEXT NOT NULL,
    "creation_date" INTEGER NOT NULL,
    "update_date" INTEGER NOT NULL,
    PRIMARY KEY ("id")
);

-- 零基预算表
CREATE TABLE "zero_based_budgets" (
    "id" TEXT NOT NULL,
    "name" TEXT NOT NULL,
    "description" TEXT NULL,
    "total_income" REAL NOT NULL,
    "total_allocated" REAL NOT NULL DEFAULT 0.0,
    "envelopes" TEXT NOT NULL,
    "period" TEXT NOT NULL,
    "start_date" INTEGER NOT NULL,
    "end_date" INTEGER NOT NULL,
    "status" TEXT NOT NULL,
    "creation_date" INTEGER NOT NULL,
    "update_date" INTEGER NOT NULL,
    PRIMARY KEY ("id")
);

-- 工资收入表
CREATE TABLE "salary_incomes" (
    "id" TEXT NOT NULL,
    "name" TEXT NOT NULL,
    "description" TEXT NULL,
    "basic_salary" REAL NOT NULL,
    "salary_history" TEXT NULL,
    "housing_allowance" REAL NOT NULL DEFAULT 0.0,
    "meal_allowance" REAL NOT NULL DEFAULT 0.0,
    "transportation_allowance" REAL NOT NULL DEFAULT 0.0,
    "other_allowance" REAL NOT NULL DEFAULT 0.0,
    "monthly_allowances" TEXT NULL,
    "bonuses" TEXT NOT NULL,
    "personal_income_tax" REAL NOT NULL DEFAULT 0.0,
    "social_insurance" REAL NOT NULL DEFAULT 0.0,
    "housing_fund" REAL NOT NULL DEFAULT 0.0,
    "other_deductions" REAL NOT NULL DEFAULT 0.0,
    "special_deduction_monthly" REAL NOT NULL DEFAULT 0.0,
    "other_tax_deductions" REAL NOT NULL DEFAULT 0.0,
    "gross_income" REAL NOT NULL,
    "net_income" REAL NOT NULL,
    "total_deductions" REAL NOT NULL,
    "salary_day" INTEGER NOT NULL,
    "period" TEXT NOT NULL,
    "last_salary_date" INTEGER NULL,
    "next_salary_date" INTEGER NULL,
    "income_type" TEXT NOT NULL,
    "creation_date" INTEGER NOT NULL,
    "update_date" INTEGER NOT NULL,
    PRIMARY KEY ("id")
);

-- 资产历史表
CREATE TABLE "asset_histories" (
    "id" TEXT NOT NULL,
    "asset_id" TEXT NOT NULL,
    "action" TEXT NOT NULL,
    "description" TEXT NOT NULL,
    "previous_state" TEXT NULL,
    "new_state" TEXT NULL,
    "timestamp" INTEGER NOT NULL,
    "user_id" TEXT NULL,
    PRIMARY KEY ("id")
);

-- 支出计划表
CREATE TABLE "expense_plans" (
    "id" TEXT NOT NULL,
    "name" TEXT NOT NULL,
    "description" TEXT NULL,
    "category" TEXT NOT NULL,
    "target_amount" REAL NOT NULL,
    "current_amount" REAL NOT NULL DEFAULT 0.0,
    "period" TEXT NOT NULL,
    "start_date" INTEGER NOT NULL,
    "end_date" INTEGER NOT NULL,
    "status" TEXT NOT NULL,
    "creation_date" INTEGER NOT NULL,
    "update_date" INTEGER NOT NULL,
    PRIMARY KEY ("id")
);

-- 收入计划表
CREATE TABLE "income_plans" (
    "id" TEXT NOT NULL,
    "name" TEXT NOT NULL,
    "description" TEXT NULL,
    "income_type" TEXT NOT NULL,
    "target_amount" REAL NOT NULL,
    "current_amount" REAL NOT NULL DEFAULT 0.0,
    "period" TEXT NOT NULL,
    "start_date" INTEGER NOT NULL,
    "end_date" INTEGER NOT NULL,
    "status" TEXT NOT NULL,
    "creation_date" INTEGER NOT NULL,
    "update_date" INTEGER NOT NULL,
    PRIMARY KEY ("id")
);
```

### 2. 键值存储 (SharedPreferences)

#### 位置
```
~/Library/Developer/CoreSimulator/Devices/[DEVICE_ID]/data/Containers/Data/Application/[APP_ID]/Library/Preferences/com.example.yourFinanceFlutter.plist
```

#### 数据格式
SharedPreferences 以 JSON 字符串形式存储复杂数据：

```json
{
  "flutter.assets_data": "[{\"id\":\"95b2be4e-9e97-48f6-ae57-e6c0f0b310c7\",\"name\":\"房产 (自住)\",\"amount\":4252237.0,\"category\":\"realEstate\",\"subCategory\":\"杭州滨江时舟里1栋1201\",\"creationDate\":\"2025-09-11T16:08:43.506145\",\"updateDate\":\"2025-09-11T17:40:05.082326\",\"purchaseDate\":null,\"depreciationMethod\":\"none\",\"depreciationRate\":null,\"currentValue\":null,\"isIdle\":false,\"idleValue\":null,\"notes\":\"{\\\"propertyDetails\\\": {\\\"address\\\":\\\"杭州市滨江时舟里1栋1201\\\",\\\"area\\\":\\\"124\\\",\\\"purchaseYear\\\":\\\"2025\\\",\\\"propertyType\\\":\\\"住宅\\\",\\\"propertyUsage\\\":\\\"自住\\\",\\\"notes\\\":\\\"\\\"}}\"}]",

  "flutter.accounts_data": "[{\"id\":\"c190160b-ec88-497d-8564-2db89e4c1fb3\",\"name\":\"杭州公积金\",\"description\":null,\"type\":\"asset\",\"status\":\"active\",\"balance\":0.0,\"initialBalance\":177294.57,\"currency\":\"CNY\",\"bankName\":null,\"accountNumber\":null,\"cardNumber\":null,\"creditLimit\":null,\"interestRate\":null,\"openDate\":null,\"closeDate\":null,\"loanType\":null,\"loanAmount\":null,\"secondInterestRate\":null,\"loanTerm\":null,\"repaymentMethod\":null,\"firstPaymentDate\":null,\"remainingPrincipal\":null,\"monthlyPayment\":null,\"isRecurringPayment\":false,\"iconName\":null,\"color\":null,\"isDefault\":false,\"isHidden\":false,\"tags\":[],\"creationDate\":\"2025-09-26T10:09:34.586214\",\"updateDate\":\"2025-09-26T10:09:34.618616\",\"syncProvider\":null,\"syncAccountId\":null,\"lastSyncDate\":null}]",

  "flutter.transactions_data": "[{\"id\":\"f8750766-a2ea-4016-ae13-740c7174c579\",\"description\":\"账户初始化\",\"amount\":177294.57,\"flow\":null,\"type\":\"income\",\"category\":\"otherIncome\",\"subCategory\":null,\"fromWalletId\":null,\"toWalletId\":null,\"fromAssetId\":null,\"toAssetId\":null,\"fromAccountId\":null,\"toAccountId\":\"c190160b-ec88-497d-8564-2db89e4c1fb3\",\"envelopeBudgetId\":null,\"date\":\"2025-09-26T10:09:34.586214\",\"notes\":\"账户初始余额设置\",\"tags\":[],\"status\":\"confirmed\",\"isRecurring\":false,\"recurringRule\":null,\"parentTransactionId\":null,\"creationDate\":\"2025-09-26T10:09:34.616225\",\"updateDate\":\"2025-09-26T10:09:34.616225\",\"imagePath\":null,\"isAutoGenerated\":true}]",

  "flutter.envelope_budgets_data": "[{\"id\":\"563ecafd-56a6-4b7b-a252-1b84166088e1\",\"name\":\"房贷月供 - 组合贷款\",\"description\":null,\"category\":\"housing\",\"allocatedAmount\":14248.94400108447,\"spentAmount\":0.0,\"period\":\"monthly\",\"startDate\":\"2025-09-01T00:00:00.000\",\"endDate\":\"2025-09-30T00:00:00.000\",\"status\":\"active\",\"color\":null,\"iconName\":null,\"isEssential\":false,\"warningThreshold\":80.0,\"limitThreshold\":100.0,\"tags\":[],\"creationDate\":\"2025-09-11T19:57:53.537001\",\"updateDate\":\"2025-09-11T19:57:53.537002\"}]",

  "flutter.zero_based_budgets_data": "[{\"id\":\"d43ce9f0-f12c-460e-957f-0b0e8bae0441\",\"name\":\"房贷预算 - 组合贷款\",\"description\":null,\"totalIncome\":28497.88800216894,\"totalAllocated\":0.0,\"envelopes\":[],\"period\":\"monthly\",\"startDate\":\"2025-09-01T00:00:00.000\",\"endDate\":\"2025-09-30T00:00:00.000\",\"status\":\"active\",\"creationDate\":\"2025-09-11T19:57:53.531558\",\"updateDate\":\"2025-09-11T19:57:53.531559\"}]",

  "flutter.salary_incomes_data": "[{\"id\":\"6435f7a0-0842-4c0d-aed3-6cce87bd478e\",\"name\":\"工资收入\",\"description\":\"每月 31 日发放\",\"basicSalary\":34000.0,\"salaryHistory\":{\"2025-01-01T00:00:00.000\":30000.0,\"2025-04-30T00:00:00.000\":34000.0},\"housingAllowance\":0.0,\"mealAllowance\":420.0,\"transportationAllowance\":800.0,\"otherAllowance\":0.0,\"monthlyAllowances\":null,\"bonuses\":[{\"id\":\"1757656075730\",\"name\":\"FY25年终\",\"type\":1,\"amount\":190000.0,\"frequency\":0,\"paymentCount\":1,\"startDate\":\"2025-04-15T00:00:00.000\",\"endDate\":null,\"description\":null,\"quarterlyPaymentMonths\":null,\"thirteenthSalaryMonth\":null,\"awardDate\":\"2025-04-15T00:00:00.000\",\"attributionDate\":\"2025-04-15T00:00:00.000\",\"creationDate\":\"2025-09-12T13:47:55.731035\",\"updateDate\":\"2025-09-24T11:12:42.946448\"}],\"personalIncomeTax\":832.0,\"socialInsurance\":2617.65,\"housingFund\":4883.0,\"otherDeductions\":300.0,\"specialDeductionMonthly\":1200.0,\"otherTaxDeductions\":0.0,\"grossIncome\":35220.0,\"netIncome\":25387.35,\"totalDeductions\":9832.65,\"salaryDay\":31,\"period\":\"monthly\",\"lastSalaryDate\":null,\"nextSalaryDate\":null,\"incomeType\":\"salary\",\"creationDate\":\"2025-09-12T13:48:35.052935\",\"updateDate\":\"2025-09-25T11:54:25.205384\"}]",

  "flutter.asset_history_data": "[{\"id\":\"1757581999136\",\"assetId\":\"95b2be4e-9e97-48f6-ae57-e6c0f0b310c7\",\"asset\":{\"id\":\"95b2be4e-9e97-48f6-ae57-e6c0f0b310c7\",\"name\":\"房产 (自住)\",\"amount\":4252237.0,\"category\":\"realEstate\",\"subCategory\":\"房产 (自住)\",\"creationDate\":\"2025-09-11T16:08:43.506145\",\"updateDate\":\"2025-09-11T16:09:52.009371\",\"purchaseDate\":null,\"depreciationMethod\":\"none\",\"depreciationRate\":null,\"currentValue\":null,\"isIdle\":false,\"idleValue\":null,\"notes\":\"杭州，滨江时舟里1栋1201\"},\"changeType\":\"created\",\"changeDate\":\"2025-09-11T17:13:19.136500\",\"changeDescription\":\"新增资产: 房产 (自住)\"}]",

  "flutter.data_migration_version": 4,

  "flutter.migration_history": [
    "2025-09-15T10:10:05.837959: Migrated to version 1",
    "2025-09-15T10:10:05.840975: Migrated to version 2",
    "2025-09-15T19:03:54.615477: Migrated to version 3"
  ]
}
```

### 3. 迁移报告文件

#### 位置
```
~/Library/Developer/CoreSimulator/Devices/[DEVICE_ID]/data/Containers/Data/Application/[APP_ID]/Documents/migration_report.json
```

#### 格式
```json
{
  "modules": {
    "assets": {
      "total": 4,
      "imported": 4,
      "skipped": 0,
      "failed": 0
    },
    "accounts": {
      "total": 0,
      "imported": 0,
      "skipped": 0,
      "failed": 0
    }
  },
  "warnings": [],
  "errors": []
}
```

## 数据迁移策略

### 1. 启动时自动迁移

```dart
void main() async {
  // 初始化数据迁移服务
  final migrationService = await DataMigrationService.getInstance();
  await migrationService.checkAndMigrateData(); // 自动检测版本并迁移

  runApp(const ProviderScope(child: MyApp()));
}
```

### 2. 手动迁移 (开发者模式)

```dart
// 预览模式 - 不写入数据库
final report = await migrationService.importLegacyData(dryRun: true);

// 实际迁移
final report = await migrationService.importLegacyData(dryRun: false);

// 强制重新迁移
await migrationService.forceReMigration();
```

### 3. 数据导入优先级

1. **Drift数据库** (优先) - 新数据存储位置
2. **SharedPreferences** (回退) - 兼容旧数据
3. **JSON文件** (遗留) - 历史数据导入

### 4. 幂等性保证

- 使用 `insertAllOnConflictUpdate` 实现 upsert 操作
- 基于 ID 和内容哈希检测重复导入
- 支持多次执行而不会产生副作用

## 状态管理架构

### 1. Riverpod Provider (推荐)

```dart
// 数据库服务 Provider
final databaseServiceProvider = FutureProvider<DriftDatabaseService>(
  (ref) async => DriftDatabaseService.getInstance()
);

// 资产状态管理 Provider
final assetsProvider = StateNotifierProvider<AssetsNotifier, List<AssetItem>>((ref) {
  final notifier = AssetsNotifier();

  // 监听数据库服务初始化完成
  ref.listen<AsyncValue<DriftDatabaseService>>(databaseServiceProvider, (previous, next) {
    next.whenData((db) async {
      final assets = await db.getAssets();
      if (assets.isNotEmpty) {
        notifier.loadFromDatabase(assets);
      }
    });
  });

  return notifier;
});

// 计算属性 Provider
final totalAssetsProvider = Provider<double>((ref) {
  final assets = ref.watch(assetsProvider);
  return assets.fold<double>(0, (sum, asset) => sum + asset.amount);
});
```

### 2. Provider Package (遗留兼容)

```dart
// 应用启动时初始化所有 Provider
runApp(
  ProviderScope(
    child: MultiProvider(
      providers: [
        ChangeNotifierProvider(create: (_) => AccountProvider()..initialize()),
        ChangeNotifierProvider(create: (_) => AssetProvider()..initialize()),
        ChangeNotifierProvider(create: (_) => BudgetProvider()..initialize()),
        // ... 其他 Provider
      ],
      child: const MyApp(),
    ),
  ),
);
```

### 3. 混合架构

```
Riverpod (新功能)
├── assetsProvider (Drift-backed)
├── totalAssetsProvider (computed)
└── assetCountProvider (computed)

Provider (遗留兼容)
├── AccountProvider (SharedPreferences)
├── BudgetProvider (SharedPreferences)
└── TransactionProvider (SharedPreferences)
```

## 数据类型映射

### 1. 资产分类枚举

```dart
enum AssetCategory {
  liquidAssets('流动资产'),      // 现金、存款等
  realEstate('不动产'),          // 房产等
  investments('投资理财'),       // 股票、基金等
  consumptionAssets('消费资产'), // 电脑、家具等
  receivables('应收款'),         // 他人欠款
  liabilities('债务');           // 欠他人的钱
}
```

### 2. 数据库字段映射

```dart
// Dart Model → Database Column
class AssetItem {
  String id;              // → assets.id (TEXT PRIMARY KEY)
  String name;            // → assets.name (TEXT NOT NULL)
  double amount;          // → assets.amount (REAL NOT NULL)
  String category;        // → assets.category (TEXT NOT NULL)
  String subCategory;     // → assets.sub_category (TEXT NOT NULL)
  DateTime creationDate;  // → assets.creation_date (INTEGER NOT NULL)
  DateTime updateDate;    // → assets.update_date (INTEGER NOT NULL)
  // ... 其他字段
}
```

### 3. JSON 序列化

```dart
// 资产数据 JSON 示例
{
  "id": "95b2be4e-9e97-48f6-ae57-e6c0f0b310c7",
  "name": "房产 (自住)",
  "amount": 4252237.0,
  "category": "realEstate",
  "subCategory": "杭州滨江时舟里1栋1201",
  "creationDate": "2025-09-11T16:08:43.506145",
  "updateDate": "2025-09-11T17:40:05.082326",
  "notes": "{\"propertyDetails\": {\"address\":\"杭州市滨江时舟里1栋1201\",\"area\":\"124\",\"purchaseYear\":\"2025\",\"propertyType\":\"住宅\",\"propertyUsage\":\"自住\"}}"
}
```

## 性能优化

### 1. 数据库查询优化

```dart
// 使用索引字段进行查询
Future<Asset?> getAssetById(String id) =>
  (select(assets)..where((a) => a.id.equals(id))).getSingleOrNull();

// 批量操作使用事务
await _database.batch((batch) {
  batch.insertAllOnConflictUpdate(assets, assetCompanions);
});
```

### 2. 状态管理优化

```dart
// 避免不必要的重建
final assetCount = ref.watch(assetCountProvider); // 只监听计数变化

// 使用 select 进行细粒度监听
final assetNames = ref.watch(
  assetsProvider.select((assets) => assets.map((a) => a.name).toList())
);
```

### 3. 内存管理

- Drift 使用懒加载数据库连接
- Provider 及时释放资源
- 避免在 build 方法中进行复杂计算

## 开发调试

### 1. 数据库检查

```dart
// 检查数据库内容
final db = await DriftDatabaseService.getInstance();
final assets = await db.getAssets();
print('数据库中的资产数量: ${assets.length}');
```

### 2. 迁移报告查看

```dart
// 查看迁移结果
final report = await migrationService.importLegacyData(dryRun: true);
print('导入统计: ${report.modules['assets']?.total} 条资产记录');
```

### 3. 状态调试

```dart
// 监听状态变化
ref.listen<List<AssetItem>>(assetsProvider, (previous, next) {
  print('资产状态更新: ${previous?.length} → ${next.length}');
});
```

## 总结

该应用采用现代化数据存储架构：

1. **主存储**: Drift (类型安全 SQLite ORM)
2. **兼容存储**: SharedPreferences (键值存储)
3. **状态管理**: Riverpod + Provider (混合架构)
4. **迁移策略**: 自动检测版本并导入遗留数据

这种设计既保证了数据的一致性和类型安全，又提供了良好的向后兼容性和性能表现。








