# 薪资收入设置页面重构方案

## 文档概述

本文档记录了对当前薪资收入设置页面的彻底重构方案，目标是实现**职责分离、极致精简、自动化计算**，将页面从"数据录入+计算配置"的混合体，重构为单一的**"核心数据模型录入"**。

**版本：** v2.1（已根据最终锐评深化）

**核心强化点：**
- **UI组件系统：** 必须完整使用现代 iOS Fintech 风格设计系统（AppTextField, AppPrimaryButton, AppSwitch, AppCard, AppDesignTokens）
- Page A：消除最后的"配置残余"，让"事实"更纯粹（入职日期替代年中模式，基数不允许手动输入）
- Page A UX优化：将"HR手动调整基数"优化为"基数与政策计算值不一致？"，更贴近用户实际情况
- Page B：默认展示系统最优解，让"沙盒"更智能（成为真正的税务规划中心）
- Page B 价值深化：增加"预测年度汇算清缴结果"和"年度预测净收入盈余"，提升到**"年度税务规划决策中心"**
- 技术依赖：强调社保政策数据服务（Policy Data Service）的关键性

---

## Part I. 重构目标：两页模型分离

### 目标架构

| 页面名称 | 页面路径 | 核心职责 | 核心数据流向 |
|---------|---------|---------|------------|
| **页面 A: 薪资核心数据模型** | `/family-info/salary/setup` | 录入静态、不变的基准事实（Base Model） | 读写数据库，作为年度预算和预测的输入 |
| **页面 B: 税务预测与沙盒工具** | `/financial-planning/tax-prediction` | 展示页面 A 数据模型的结果，并提供临时性计算配置（Logic Switch） | 只读页面 A 模型；所有开关调整不写入数据库，仅用于临时对比 |

### 核心原则

1. **职责单一原则 (Single Responsibility Principle)**：页面 A 只负责录入事实，页面 B 只负责展示和临时配置
2. **自动化优先**：后端已有计算能力，前端不应要求用户手动输入计算结果
3. **即时反馈**：录入完成后立即跳转到预测页面，让用户看到结果
4. **非持久化沙盒**：页面 B 的所有配置都是临时性的，不保存到数据库

---

## Part II. 当前设计现状分析

### 页面 A 现状：`SalaryIncomeSetupScreen`

#### ✅ 当前已有的功能

1. **基础信息录入**
   - ✅ 收入名称、基本工资、发薪日
   - ✅ 年中模式开关（`_isMidYearMode`）
   - ✅ 自动计算开关（`_useAutoCalculation`）

2. **津贴录入**
   - ✅ 固定津贴（住房、餐补、交通、其他）
   - ✅ 月度特殊津贴调整（`MonthlyAllowanceAdjustmentWidget`）

3. **奖金录入**
   - ✅ 奖金列表管理（`BonusManagementWidget`）
   - ✅ 支持多种奖金类型和频率

4. **扣除项录入**
   - ✅ 个税、社保、公积金、其他扣除
   - ✅ 专项附加扣除
   - ✅ "自动计算"按钮（但用户仍可手动输入）

5. **工资历史**
   - ✅ 工资历史记录（`SalaryHistoryWidget`）

6. **AI 识别**
   - ✅ 拍照识别工资条功能

#### ❌ 当前设计的问题（与重构目标对比）

| 问题类别 | 具体问题 | 重构目标 |
|---------|---------|---------|
| **缺失关键事实** | ❌ 没有"就业城市/社保基数城市"输入 | ✅ 必须新增：这是社保公积金自动计算的唯一事实依据 |
| **事实与逻辑混淆** | ❌ "年中模式"是一个开关（逻辑配置） | ✅ **强化：** 改为"入职日期"字段（纯粹事实） |
| **手动输入计算结果** | ❌ 社保、公积金、个税都是手动输入框 | ✅ 改为只读展示，系统自动计算。**强化：** 基数不允许手动输入（除非HR手动调整） |
| **缺乏计算透明度** | ❌ 用户看不到计算依据（基数、比例、预扣率） | ✅ **强化：** 在只读结果下方显示计算依据，建立信任感 |
| **配置项混入数据录入** | ❌ 计税方式选择（`TaxCalculationMode`）在预览页面，但仍影响数据模型 | ✅ 移除所有计算配置项，移至页面 B |
| **缺乏即时反馈** | ❌ 保存后停留在当前页面，没有跳转到预测页面 | ✅ 保存后自动跳转到页面 B |
| **缺乏自动化** | ❌ "自动计算"按钮存在，但计算结果仍可被手动覆盖 | ✅ 计算结果应为只读，不可手动修改 |

#### 当前字段清单（需要改造的）

**基础信息区域：**
- ✅ 收入名称（保留）
- ✅ 基本工资（保留）
- ✅ 发薪日（保留）
- ❌ **缺失：就业城市/社保基数城市**（需新增）
- ❌ 年中模式开关（需评估：是否属于"配置"而非"事实"）

**扣除项区域（`TaxDeductionsWidget`）：**
- ❌ 个税输入框（需改为只读展示）
- ❌ 社保输入框（需改为只读展示）
- ❌ 公积金输入框（需改为只读展示）
- ✅ 专项附加扣除（保留，但需优化交互）
- ✅ 其他扣除（保留）

**奖金区域：**
- ✅ 奖金列表（保留）
- ❌ **缺失：奖金计税方式开关**（需移除，移至页面 B）

---

### 页面 B 现状：`SalaryPreviewScreen`

#### ✅ 当前已有的功能

1. **结果展示**
   - ✅ 显示税前收入、扣除项、税后收入
   - ✅ 可展开的计算详情（`SalarySummaryWidget`）

2. **计税方式切换**
   - ✅ "修改模式"按钮，可切换 `TaxCalculationMode`
   - ✅ 支持单独计税/合并计税

#### ❌ 当前设计的问题（与重构目标对比）

| 问题类别 | 具体问题 | 重构目标 |
|---------|---------|---------|
| **定位不清晰** | ❌ 这是一个"预览"页面，不是独立的"预测工具" | ✅ 独立的"税务预测与沙盒工具"页面 |
| **缺乏年度视角** | ❌ 只显示单月或当前计算结果 | ✅ 年度总税后净收入、年度总纳税额、年度总收入 |
| **缺乏可视化** | ❌ 没有图表展示 | ✅ 月度净收入柱状图，突出奖金月份波动 |
| **缺乏月度流水** | ❌ 没有未来12个月的预测列表 | ✅ 月度流水预测列表，可点击查看详细计算步骤 |
| **沙盒逻辑不完整** | ❌ 只有计税方式切换，且用户需要自己选择 | ✅ **强化：** 默认展示系统最优解，将切换器重命名为"方案对比"。补充年度报税假设功能（临时大额专项扣除、家庭其他收入假设） |
| **缺乏年度汇算视角** | ❌ 只关注月度预扣，不关注年度汇算清缴 | ✅ **强化：** 沙盒功能必须覆盖年度汇算清缴的关键假设，成为真正的**税务规划中心** |
| **配置持久化问题** | ❌ 计税方式切换可能影响数据模型 | ✅ 所有沙盒配置必须非持久化，不写入数据库 |

---

## Part III. 重构方案详细设计

### 页面 A：薪资核心数据模型 (`/family-info/salary/setup`)

#### 字段精简与优化

| 区域 | 原字段（存在或缺失） | 改造后字段 | 交互方式 | 改造说明 |
|-----|-------------------|-----------|---------|---------|
| **基础信息** | ❌ 无（缺失） | **就业城市/社保公积金基数城市** | 城市标准下拉框样式 | **新增！** 这是社保公积金自动计算的唯一事实依据 |
| | ❌ 年中模式开关 | **入职日期 (Employment Start Date)** | 日期选择器样式 | **强化：** 将"年中模式"开关替换为"入职日期"字段。如果该日期在年度内，则自动触发年中累计预扣的计算逻辑。这是一个纯粹的事实，而非逻辑配置 |
| | ✅ 基本工资（月） | 基本工资（月金额） | 金额输入框样式 | 核心固定收入事实 |
| | ✅ 固定津贴（月） | 固定津贴（月金额） | 金额输入框样式 | 固定且不涉税的津贴，如餐补 |
| **保险/公积金** | ❌ 养老、医疗、公积金比例/金额 | **社保公积金基数** | **只读展示** | **强化：** 基数应由系统根据城市政策和基本工资自动在法定范围内取值。**不允许手动输入**，除非开启"HR手动调整基数"开关（需记录覆盖原因和操作人，标记为"非自动"用于审计） |
| **年度奖金** | ✅ 年终奖金额、发放月份 | 年终奖金额 | 金额输入框样式 | 保留。录入金额事实 |
| | ❌ 奖金单独计税开关 | **移除！** | N/A | 逻辑开关移至预测沙盒（页面 B） |
| **个税扣除** | ✅ 专项附加扣除项 | 专项附加扣除项（列表） | 勾选/输入模块 | 保留。录入房租、子女教育等事实，无需用户输入金额 |
| | ❌ 个税预扣率 | **移除！** | N/A | 后端自动计算。用户不应配置 |
| **临时调整** | ❌ 月度手工调整 | **移除！** | N/A | 临时调整应作为流水记账或预测沙盒的临时变量 |

#### 交互逻辑与验收标准

1. **自动化计算（强化透明度）**
   - ✅ 当用户输入**"就业城市"和"基本工资"后，系统应立即通过后端接口计算出养老、医疗、公积金的月度扣款金额**
   - ✅ 计算结果以**只读形式**展示在页面上
   - ✅ **强化：** 在只读的"扣款金额"下方，新增一行小字显示计算依据：
     - 社保公积金：`基数：[X,XXX.XX]；比例：[Y.Y]%`
     - 个税：`本月预扣率：[Z]% (基于累计收入和已扣除额)`
   - ✅ **目的：** 建立透明度，明确告知用户计算依据。如果结果不对，用户知道应该找谁（HR）询问基数或比例

2. **社保公积金基数处理（强化纯粹性 + UX优化）**
   - ✅ **默认行为：** 基数由系统根据城市政策和基本工资自动在法定范围内取值，**不允许手动输入**
   - ✅ **特殊场景（UX优化）：** 如果基数与政策计算值不一致，显示提示："基数与政策计算值不一致？"（而非"HR手动调整基数"）
   - ✅ **交互流程：** 点击提示后展开"手动录入"和"审计信息"表单，更贴近用户实际情况（如：HR告知我的基数是X，但系统算出来是Y）
   - ✅ **审计要求：** 一旦开启手动调整，系统需记录：
     - 覆盖原因（文本输入）
     - 操作人（当前用户）
     - 数据标记为**"非自动"**，用于后续审计

3. **保存后跳转**
   - ✅ 保存成功后，系统不应停留在本页，而应自动跳转至**"税务预测与沙盒工具"页面 (Page B)，让用户立即查看数据模型带来的预测结果**

---

### 页面 B：税务预测与沙盒工具 (`/financial-planning/tax-prediction`)

#### 页面定位与核心功能

- **定位**：这是一个**"财务规划"**工具，用于可视化和对比不同税务政策对年度净收入的影响
- **核心**：结果展示 (Results) + 临时逻辑配置 (Sandbox Logic)

#### 页面内容架构

| 区域名称 | 内容描述 | 交互特性 |
|---------|---------|---------|
| **结果总览** | 1. 年度总税后净收入、年度总纳税额、年度总收入<br>2. **新增：预测年度汇算清缴结果**（应退/应补税额 ￥XXX.XX）<br>3. **新增：年度预测净收入盈余**（扣除年度预算和年度税款后的实际可支配现金流） | 只读展示。数据来源于页面 A 的模型和后端实时计算。**强化：** 将 Page B 的定位从"预测工具"提升到**"年度税务规划决策中心"** |
| **可视化图表** | 月度净收入柱状图 | 核心展示。突出奖金月份的净收入波动，让用户清晰感知年度现金流 |
| **逻辑沙盒 (Sandbox)** | 1. 奖金计税方式对比开关（**强化：默认展示系统最优解**）<br>2. 年度税前收入假设<br>3. 临时专项附加调整开关<br>4. **新增：临时大额专项扣除**（养老金投资、健康险等）<br>5. **新增：家庭其他收入假设**（配偶收入、投资收入等） | **强化策略：**<br>- **默认展示系统最优解：** 页面 B 加载时，默认的图表和结果总览必须展示"系统最优解"的计算结果<br>- **强调文案：** "系统推荐：采用单独计税，可节省个税 ￥XXX.XX"<br>- **重命名：** 将沙盒切换器重命名为"方案对比"，让用户主动去选择另外两个非最优选项来查看差异<br>- **年度汇算清缴视角：** 沙盒功能必须覆盖月度预扣和年度汇算清缴的关键假设，成为真正的**税务规划中心** |
| **月度流水预测** | 以列表形式展示未来 12 个月（或年度周期）的：应发金额、社保扣款、公积金扣款、应纳税所得额、预扣个税、税后净收入 | 可点击月份查看详细计算步骤（提升透明度） |

#### 沙盒逻辑的实现要求

1. **实时反馈 (Real-time Feedback)**
   - ✅ 沙盒中的所有开关和假设输入，必须在 100ms 内驱动后端重新计算（或前端模型内计算），并立即更新页面上的结果总览和可视化图表

2. **非持久化 (Non-Persistence)**
   - ✅ 页面 B 的所有"沙盒配置"和"假设输入"都属于临时状态，用户离开页面后，不得保存到数据库
   - ✅ 数据库中保存的计算依据，永远是页面 A (`/family-info/salary/setup`) 中的核心数据模型

---

## Part IV. 验收标准

### 页面 A 验收指标

- [ ] ✅ 页面 A 中，所有涉及税务计算的比例、税率、计税方式开关等配置项必须被移除
- [ ] ✅ 页面 A 必须包含**"就业城市/社保基数城市"**这一关键事实输入项
- [ ] ✅ 社保、公积金、个税的计算结果必须以**只读形式**展示，不可手动修改
- [ ] ✅ 用户在页面 A 保存后，必须自动跳转至页面 B，展示年度税收预测图表

### 页面 B 验收指标

- [ ] ✅ 页面 B 必须包含**"奖金计税方式对比开关"**，且切换该开关时，不会对数据库中的用户配置产生任何写入操作
- [ ] ✅ 页面 B 必须展示年度总税后净收入、年度总纳税额、年度总收入
- [ ] ✅ 页面 B 必须包含月度净收入柱状图，突出奖金月份的净收入波动
- [ ] ✅ 页面 B 必须包含月度流水预测列表（未来12个月）
- [ ] ✅ 页面 B 的所有沙盒配置切换必须在 100ms 内实时更新结果

---

## Part V. 技术实现要点

### 后端依赖

1. **社保政策数据服务 (Social Security Policy Data Service) - 关键依赖**
   - ⚠️ **重要性：** 这是整个自动化计算的核心基础，如果该服务不健全或更新不及时，重构的价值将为零
   - **必需数据：**
     - 各城市社保/公积金的最新比例（单位/个人）
     - 各城市社保/公积金的最新上下限基数
     - 年度调整日期（例如，每年 7 月调整基数）
     - 政策变更历史记录（用于审计和追溯）
   - **更新机制要求：**
     - 政策变动后 1 天内必须更新
     - 需要版本控制和变更通知机制
     - 前端需要显示政策数据的最后更新时间

2. **社保公积金自动计算服务**
   - 需要根据"就业城市"和"基本工资"自动计算养老、医疗、失业、工伤、生育、公积金的月度扣款
   - **基数计算逻辑：** 根据城市政策和基本工资，在法定范围内自动取值（不允许手动输入，除非HR手动调整）
   - 需要返回各险种的比例、基数和金额（用于只读展示和透明度说明）

3. **税务计算服务**
   - 已有 `TaxCalculator` Domain 层，需要集成到页面 A 的自动计算流程
   - 需要支持年度累计预扣计算（用于页面 B 的月度流水预测）
   - **系统最优解计算：** 需要实现奖金计税方式的自动对比算法，找出最优方案

### 前端实现

#### ⚠️ **UI组件系统要求（必须严格执行）**

本次重构**必须完整使用**之前建立的现代 iOS Fintech 风格设计系统，严禁使用旧的 Material 组件：

**必须使用的组件：**
- ✅ `AppTextField` - 替代所有 `TextFormField` / `TextField`
- ✅ `AppPrimaryButton` - 替代所有 `ElevatedButton`
- ✅ `AppSwitch` - 替代所有 `Switch`
- ✅ `AppCard` - 已在使用，继续使用
- ✅ `AppDesignTokens` - 所有颜色、间距、字体必须使用 Design Tokens
- ✅ `AppTextStyles` - 所有文字样式必须使用 Text Styles
- ✅ `AppSegmentedControl` - 用于方案对比切换器
- ✅ `AppTag` - 用于标签展示（如城市标签）

**严禁使用的组件：**
- ❌ `TextFormField` / `TextField`（Material 风格）
- ❌ `ElevatedButton` / `TextButton`（Material 风格）
- ❌ `Switch`（Material 风格）
- ❌ 硬编码的颜色值（如 `Colors.blue`）
- ❌ 硬编码的间距值（如 `EdgeInsets.all(8.0)`）

**设计规范：**
- 所有输入框使用 iOS 风格（无边框、灰色填充、12pt 圆角）
- 所有按钮使用 56pt 高度，带按压动画
- 所有卡片使用弥散阴影（blurRadius 32, opacity 0.08）
- 所有文字使用 iOS 排版系统（LargeTitle, Title1, Body 等）

1. **页面 A 改造**
   - 新增"就业城市"下拉选择器（使用 `AppTextField` + 下拉菜单，需要城市列表数据源）
   - 将 `TaxDeductionsWidget` 中的输入框改为只读展示（使用 `AppTextField` 的 `enabled: false` 状态）
   - 替换所有 `Switch` 为 `AppSwitch`
   - 替换所有按钮为 `AppPrimaryButton`
   - 实现保存后自动跳转到页面 B 的逻辑

2. **页面 B 新建**
   - 创建新的路由 `/financial-planning/tax-prediction`
   - 实现结果总览、可视化图表、逻辑沙盒、月度流水预测四个区域
   - 使用 `AppSegmentedControl` 实现方案对比切换器
   - 使用 `AppCard` 和 `AppDesignTokens` 构建所有UI元素
   - 实现实时计算和更新逻辑（使用 `TaxCalculator`）

---

## Part VI. 当前代码文件清单

### 需要修改的文件

1. **页面 A**
   - `lib/features/family_info/screens/salary_income_setup_screen.dart` - 主页面
   - `lib/features/family_info/widgets/tax_deductions_widget.dart` - 扣除项组件（需改为只读）
   - `lib/features/family_info/widgets/salary_basic_info_widget.dart` - 基础信息组件（需新增城市选择）

2. **页面 B（新建）**
   - `lib/features/financial_planning/screens/tax_prediction_screen.dart` - 新建预测页面
   - `lib/features/financial_planning/widgets/tax_prediction_chart.dart` - 新建图表组件
   - `lib/features/financial_planning/widgets/monthly_tax_forecast_list.dart` - 新建月度流水列表组件

3. **路由配置**
   - `lib/core/router/app_router.dart` - 新增页面 B 路由

4. **服务层（可能需要新增）**
   - `lib/core/services/social_security_calculator.dart` - 社保公积金自动计算服务（可能需要新建）

---

## Part VII. 实施优先级

### Phase 1: 页面 A 核心改造（必须完成）

**UI组件迁移（前置任务）：**
1. ✅ 将所有 `TextFormField` 替换为 `AppTextField`
2. ✅ 将所有 `Switch` 替换为 `AppSwitch`
3. ✅ 将所有 `ElevatedButton` 替换为 `AppPrimaryButton`
4. ✅ 移除所有硬编码的颜色和间距，使用 `AppDesignTokens`

**功能改造：**
5. ✅ 新增"就业城市"输入字段（使用 `AppTextField` + 下拉选择）
6. ✅ **强化：** 将"年中模式"开关替换为"入职日期"字段（使用日期选择器）
7. ✅ **强化：** 实现社保公积金自动计算（只读展示），基数不允许手动输入（除非HR手动调整）
8. ✅ **强化：** 增加计算透明度（显示基数、比例、预扣率等计算依据）
9. ✅ 移除所有计算配置项（如计税方式开关、自动计算开关）
10. ✅ 实现保存后自动跳转到页面 B

### Phase 2: 页面 B 核心功能（必须完成）

**UI组件要求：**
1. ✅ 使用 `AppCard` 构建所有卡片区域
2. ✅ 使用 `AppSegmentedControl` 实现方案对比切换器
3. ✅ 使用 `AppDesignTokens` 和 `AppTextStyles` 构建所有UI元素
4. ✅ 使用图表库（如 `fl_chart`）实现月度净收入柱状图，遵循 iOS 风格配色

**功能实现：**
5. ✅ 创建页面 B 路由和基础结构
6. ✅ 实现结果总览区域（年度总税后净收入、年度总纳税额、年度总收入、预测年度汇算清缴结果、年度预测净收入盈余）
7. ✅ 实现月度净收入柱状图
8. ✅ **强化：** 实现逻辑沙盒，**默认展示系统最优解**（而非让用户选择）
9. ✅ **强化：** 将沙盒切换器重命名为"方案对比"，突出系统推荐

### Phase 3: 页面 B 增强功能（可选）

1. ⏳ 实现月度流水预测列表
2. ⏳ 实现年度税前收入假设输入
3. ⏳ 实现临时专项附加调整开关
4. ⏳ **新增：** 实现临时大额专项扣除模拟（养老金投资、健康险等）
5. ⏳ **新增：** 实现家庭其他收入假设（配偶收入、投资收入等），用于年度汇算清缴的全局评估

---

## 总结

本次重构将彻底消除"数据"与"逻辑"的混淆，使得应用的使用流程更加符合用户心智模型：

### 阶段原有方案结论 → 强化后的结论

| 阶段 | 原有方案结论 | 强化后的结论 |
|-----|------------|------------|
| **Page A (模型)** | 录入基本事实，计算只读展示 | **只录入纯粹事实**（如入职日期、城市），基数默认系统计算。任何手动干预需打上**"非自动"**标记。增加计算透明度（显示基数和比例） |
| **Page B (沙盒)** | 提供计税方式切换、年度预测图表 | **默认展示"系统最优"结果**。沙盒功能必须覆盖月度预扣和年度汇算清缴的关键假设，成为真正的**税务规划中心** |
| **成功关键** | 职责分离，保存后跳转 | **社保政策数据服务（Policy Data Service）的稳定性和实时更新机制**。这是整个自动化计算的核心基础 |

### 核心价值

- **录入模型 (Page A)**：告诉我你长什么样 (Facts Only)
- **查看结果 (Page B)**：给你算出来你会拿到多少钱 (Results & Logic)，**并推荐最优方案**

通过职责分离和自动化计算，用户不再需要理解复杂的税务规则，只需输入事实数据，系统自动给出结果和预测，并主动推荐最优方案。

### 关键风险提示

⚠️ **社保政策数据服务（Policy Data Service）** 是整个重构方案的核心依赖。如果该服务不健全或更新不及时（如政策变动 1 天内未能更新），那么 Page A 的自动化计算将立即失效，用户输入城市的行为将变得毫无意义，重构的价值将为零。**必须在实施前确保该服务的稳定性和实时更新机制。**

