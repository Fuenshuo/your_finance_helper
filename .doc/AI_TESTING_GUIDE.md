# AI功能测试指南

## 已完成功能清单

### ✅ 第一阶段（MVP）功能

#### 1. 自然语言记账（LLM）
- **功能描述**：用户通过自然语言输入交易信息，AI自动解析并填充表单
- **实现文件**：
  - `lib/core/services/ai/natural_language_transaction_service.dart`
  - `lib/features/transaction_flow/widgets/natural_language_input_widget.dart`

#### 2. 发票/收据识别（VL）
- **功能描述**：用户拍照或选择发票/收据图片，AI自动识别并填充表单
- **实现文件**：
  - `lib/core/services/ai/invoice_recognition_service.dart`
  - `lib/core/services/ai/image_processing_service.dart`
  - `lib/features/transaction_flow/widgets/invoice_recognition_widget.dart`

#### 3. 数据模型
- **ParsedTransaction**：AI解析后的交易数据模型
- **实现文件**：`lib/core/models/parsed_transaction.dart`

#### 4. 页面集成
- **AddTransactionScreen**：已集成AI功能入口
- **实现文件**：`lib/features/transaction_flow/screens/add_transaction_screen.dart`

---

## 测试前准备

### 1. 配置AI服务

**步骤**：
1. 打开应用
2. 进入 **设置** → **AI配置**（或直接导航到AI配置页面）
3. 选择AI服务提供商：
   - **DashScope（阿里云）** 或 **SiliconFlow**
4. 输入API Key
5. 选择LLM模型（用于自然语言记账）
6. 选择Vision模型（用于发票识别）
7. 点击 **启用AI服务**
8. 点击 **保存配置**

**测试API Key**：
- 点击 **验证API Key** 按钮，确保配置正确

### 2. 准备测试数据

**自然语言记账测试用例**：
```
✅ 标准格式：
- "今天在星巴克买了杯拿铁，花了35块，用的支付宝"
- "昨天收到工资5000元，存入工商银行"
- "打车花了25元，用微信支付"

✅ 简化格式：
- "星巴克拿铁35元"
- "工资5000"
- "打车25"

✅ 复杂格式：
- "今天中午在海底捞吃了火锅，一共花了268元，用支付宝付的，记到餐饮预算里"
```

**发票识别测试**：
- 准备几张清晰的发票/收据照片
- 建议使用：
  - 餐饮发票（星巴克、麦当劳等）
  - 购物小票（超市、便利店等）
  - 交通票据（出租车、地铁等）

---

## 测试位置

### 主入口：添加交易页面

**导航路径**：
1. 打开应用
2. 进入 **交易流水** 模块
3. 点击 **添加交易** 按钮（+号）

**页面位置**：
- 文件：`lib/features/transaction_flow/screens/add_transaction_screen.dart`
- 路由：`/add-transaction`

---

## 功能测试步骤

### 测试1：自然语言记账

#### 步骤：
1. **打开添加交易页面**
   - 进入交易流水模块
   - 点击添加交易按钮

2. **查看AI功能入口**
   - 如果AI服务已启用，页面顶部会显示 **"AI智能记账"** 卡片
   - 如果未启用，不会显示此卡片

3. **输入自然语言描述**
   ```
   例如：今天在星巴克买了杯拿铁，花了35块，用的支付宝
   ```

4. **点击发送按钮**（或按回车键）
   - 输入框右侧会显示加载动画
   - 等待AI解析（通常2-5秒）

5. **查看解析结果**
   - **成功**：表单自动填充，显示绿色提示"解析成功！已自动填充表单"
   - **部分成功**：显示橙色提示"解析完成，但信息不完整，请手动补充"
   - **失败**：显示红色错误提示

6. **验证填充结果**
   - 检查描述字段是否填充
   - 检查金额是否正确
   - 检查分类是否匹配
   - 检查账户是否选择
   - 检查日期是否正确

7. **确认或修改**
   - 可以手动修改任何字段
   - 点击保存按钮完成交易录入

#### 预期结果：
- ✅ 描述、金额、分类、账户等字段自动填充
- ✅ 填充的数据准确合理
- ✅ 用户可以修改任何字段
- ✅ 解析失败时有友好提示

---

### 测试2：发票/收据识别

#### 步骤：
1. **打开添加交易页面**
   - 进入交易流水模块
   - 点击添加交易按钮

2. **查看AI功能入口**
   - 页面顶部会显示 **"发票/收据识别"** 卡片

3. **选择识别方式**
   - **方式1**：点击 **"拍照识别"** 按钮
     - 调用相机拍照
     - 拍摄清晰的发票/收据
   - **方式2**：点击 **"相册选择"** 按钮
     - 从相册选择已保存的发票图片

4. **等待识别**
   - 显示识别进度（加载动画）
   - 等待AI识别（通常3-8秒）

5. **查看识别结果**
   - **成功**：表单自动填充，显示绿色提示"识别成功！已自动填充表单"
   - **部分成功**：显示橙色提示"识别完成，但信息不完整，请手动补充"
   - **失败**：显示红色错误提示

6. **查看图片预览**
   - 识别成功后，卡片下方会显示图片预览
   - 图片已自动保存到应用目录

7. **验证识别结果**
   - 检查商家名称是否正确
   - 检查金额是否准确
   - 检查日期是否正确
   - 检查分类是否匹配

8. **确认或修改**
   - 可以手动修改任何字段
   - 点击保存按钮完成交易录入
   - 图片会自动关联到交易记录

#### 预期结果：
- ✅ 商家、金额、日期等字段自动填充
- ✅ 图片自动保存并关联到交易
- ✅ 识别准确率 > 80%
- ✅ 识别失败时有友好提示

---

## 测试场景

### 场景1：AI服务未配置

**测试步骤**：
1. 不配置AI服务（或禁用AI服务）
2. 打开添加交易页面

**预期结果**：
- ✅ 不显示AI功能卡片
- ✅ 页面正常显示，不影响原有功能
- ✅ 可以正常手动录入交易

---

### 场景2：AI服务配置错误

**测试步骤**：
1. 配置错误的API Key
2. 尝试使用自然语言记账

**预期结果**：
- ✅ 显示错误提示："解析失败: AI服务未配置或已禁用"
- ✅ 不影响页面其他功能
- ✅ 可以切换到手动录入

---

### 测试3：网络异常

**测试步骤**：
1. 断开网络连接
2. 尝试使用AI功能

**预期结果**：
- ✅ 显示网络错误提示
- ✅ 不影响页面其他功能
- ✅ 可以切换到手动录入

---

### 测试4：图片格式和大小

**测试步骤**：
1. 尝试识别超大图片（>10MB）
2. 尝试识别模糊图片
3. 尝试识别非发票图片

**预期结果**：
- ✅ 超大图片显示错误提示："图片大小超过10MB限制"
- ✅ 模糊图片可能识别失败，但有友好提示
- ✅ 非发票图片可能识别不准确，但不会崩溃

---

## 验证检查清单

### 自然语言记账
- [ ] AI功能卡片正常显示
- [ ] 输入框可以正常输入
- [ ] 解析过程有加载提示
- [ ] 解析成功自动填充表单
- [ ] 解析失败有错误提示
- [ ] 可以手动修改填充的数据
- [ ] 保存后数据正确存储

### 发票识别
- [ ] AI功能卡片正常显示
- [ ] 拍照按钮可以调用相机
- [ ] 相册选择可以打开相册
- [ ] 识别过程有加载提示
- [ ] 识别成功自动填充表单
- [ ] 图片预览正常显示
- [ ] 图片正确保存
- [ ] 识别失败有错误提示
- [ ] 可以手动修改填充的数据
- [ ] 保存后数据正确存储，图片正确关联

### 兼容性测试
- [ ] AI服务未配置时不影响原有功能
- [ ] AI服务配置错误时有友好提示
- [ ] 网络异常时有友好提示
- [ ] 可以随时切换到手动录入

---

## 常见问题排查

### 问题1：AI功能卡片不显示

**可能原因**：
- AI服务未配置
- AI服务已禁用
- 配置加载失败

**解决方法**：
1. 检查AI配置页面，确认已配置并启用
2. 重新打开添加交易页面
3. 检查控制台日志，查看是否有错误

---

### 问题2：解析/识别失败

**可能原因**：
- API Key无效
- 网络连接问题
- 模型服务不可用
- 输入格式不符合要求

**解决方法**：
1. 检查API Key是否正确
2. 检查网络连接
3. 查看错误提示信息
4. 尝试不同的输入格式

---

### 问题3：图片识别不准确

**可能原因**：
- 图片质量差
- 图片格式不支持
- 发票格式特殊

**解决方法**：
1. 使用清晰的图片
2. 确保光线充足
3. 尝试不同的发票格式
4. 手动修改识别结果

---

## 性能指标

### 响应时间
- **自然语言解析**：< 3秒（正常网络）
- **发票识别**：< 5秒（正常网络）

### 准确率目标
- **自然语言解析准确率**：> 85%
- **发票识别准确率**：> 80%

---

## 测试数据建议

### 自然语言测试用例

**简单场景**：
```
- "星巴克拿铁35元"
- "工资5000"
- "打车25元"
```

**标准场景**：
```
- "今天在星巴克买了杯拿铁，花了35块，用的支付宝"
- "昨天收到工资5000元，存入工商银行"
- "打车花了25元，用微信支付"
```

**复杂场景**：
```
- "今天中午在海底捞吃了火锅，一共花了268元，用支付宝付的，记到餐饮预算里"
- "这个月发了季度奖金8000元，扣除个税后实际到账7200元，存入招商银行"
```

### 发票识别测试用例

**推荐测试图片**：
- 星巴克小票（清晰、标准格式）
- 超市购物小票（多商品）
- 餐厅发票（含税信息）
- 交通票据（简单格式）

---

## 下一步测试计划

### 第二阶段功能测试
- [ ] 智能分类建议
- [ ] 银行账单识别
- [ ] 工资条识别

### 第三阶段功能测试
- [ ] 财务洞察生成
- [ ] 清账差额智能解释
- [ ] 资产拍照估值

---

**测试文档版本**：v1.0  
**创建时间**：2025-01-13  
**维护者**：测试团队

