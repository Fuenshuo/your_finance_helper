# iOS 数据持久化解决方案

## 问题描述

在 iOS 模拟器开发过程中，每次运行 `flutter run -d [设备ID]` 都会重新安装应用，导致所有本地数据丢失。这是因为应用使用的是 SharedPreferences 存储，重新安装会清除应用的沙盒数据。

## 解决方案

### 方案1：使用热重载（推荐）

在开发过程中，尽量使用热重载而不是重新安装：

```bash
# 启动应用
flutter run -d ABE979C8-82DD-4314-A361-4117EA0876ED

# 在应用运行时使用热重载
# 按 'r' 进行热重载
# 按 'R' 进行热重启
# 按 'q' 退出应用
```

**优点**：
- 数据不会丢失
- 开发效率更高
- 不需要重新登录或设置

### 方案2：数据导出/导入功能

应用已内置完整的数据导出/导入功能：

#### 导出数据步骤：
1. 打开应用
2. 进入"资产管理"页面
3. 点击右上角的调试按钮（虫子图标）
4. 选择"导出数据"
5. 数据会自动复制到剪贴板

#### 导入数据步骤：
1. 重新安装应用后
2. 进入"资产管理"页面
3. 点击"导入数据"按钮
4. 数据会自动从剪贴板导入

### 方案3：混合存储服务（已实现）

应用现在使用混合存储服务，具有以下特性：

#### 存储策略：
- **优先使用文件系统**：数据保存在应用文档目录的 JSON 文件中
- **回退到 SharedPreferences**：如果文件系统没有数据，从 SharedPreferences 读取
- **自动迁移**：首次启动时自动将 SharedPreferences 数据迁移到文件系统

#### 文件存储位置：
```
iOS 模拟器：~/Library/Developer/CoreSimulator/Devices/[设备ID]/data/Containers/Data/Application/[应用ID]/Documents/
```

#### 存储文件：
- `assets.json` - 资产数据
- `transactions.json` - 交易数据
- `accounts.json` - 账户数据
- `envelope_budgets.json` - 信封预算数据
- `zero_based_budgets.json` - 零基预算数据

### 方案4：使用真实设备

在真实 iOS 设备上，应用数据会持久保存，不会因为重新安装而丢失。

## 最佳实践

### 开发阶段：
1. **优先使用热重载**：避免频繁重新安装
2. **定期导出数据**：在重要功能测试前导出数据作为备份
3. **使用测试数据**：利用"生成测试数据"功能快速恢复测试环境

### 生产环境：
1. **数据自动持久化**：混合存储服务确保数据安全
2. **定期备份**：用户可以手动导出数据进行备份
3. **跨设备同步**：未来可考虑添加云同步功能

## 技术实现

### 混合存储服务架构：

```dart
HybridStorageService
├── PersistentStorageService (文件系统)
│   ├── 数据持久化
│   ├── 跨安装保留
│   └── 备份/恢复
└── StorageService (SharedPreferences)
    ├── 快速访问
    ├── 兼容性
    └── 回退机制
```

### 数据流程：

1. **写入数据**：同时保存到文件系统和 SharedPreferences
2. **读取数据**：优先从文件系统读取，回退到 SharedPreferences
3. **数据迁移**：首次启动时自动迁移 SharedPreferences 数据到文件系统
4. **数据同步**：确保两种存储方式数据一致

## 故障排除

### 数据丢失问题：
1. 检查是否使用了热重载而不是重新安装
2. 确认文件系统权限正常
3. 使用导出/导入功能恢复数据

### 性能问题：
1. 文件系统存储可能比 SharedPreferences 稍慢
2. 大量数据时考虑分批处理
3. 定期清理过期数据

### 兼容性问题：
1. 混合存储服务向后兼容 SharedPreferences
2. 自动处理数据格式转换
3. 支持渐进式升级

## 总结

通过实现混合存储服务，应用现在具备了更强的数据持久化能力：

- ✅ **开发友好**：支持热重载，减少数据丢失
- ✅ **数据安全**：文件系统存储，跨安装保留
- ✅ **向后兼容**：支持 SharedPreferences 数据迁移
- ✅ **用户友好**：提供导出/导入功能
- ✅ **性能优化**：智能存储策略，平衡性能和持久性

这个解决方案确保了在开发和生产环境中都能提供可靠的数据持久化体验。
